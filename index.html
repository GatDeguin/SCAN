<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini App Inventario ¬∑ Esc√°ner + CSV/XLSX</title>
  <style>
    /* =========================
       Dise√±o responsive, mobile‚Äëfirst
       ========================= */
    :root{
      --bg: #0b1020;
      --panel: #101736;
      --muted: #8a96b9;
      --text: #f2f5ff;
      --brand: #7cf2d3;
      --accent: #9aa8ff;
      --danger: #ff6b6b;
      --warn: #ffbf69;
      --ok: #38d996;
      --card: #0f142a;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04);
      --radius: 16px;
      --space: clamp(10px, 2.2vw, 18px);
      --text-sm: clamp(12px, 1.4vw, 13px);
      --text-md: clamp(14px, 1.6vw, 15px);
      --text-lg: clamp(16px, 2vw, 18px);
      --text-xl: clamp(18px, 3vw, 22px);
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 600px at 20% -10%, #1d2450 0%, transparent 50%),
                  radial-gradient(1200px 600px at 120% 10%, #17324a 0%, transparent 45%),
                  var(--bg);
    }

    /* Layout principal: grid fluido */
    .app{display:grid; grid-template-columns: minmax(0,1fr); gap:var(--space); min-height:100dvh; padding:var(--space); box-sizing:border-box}
    @media (min-width: 980px){
      .app{grid-template-columns: 380px minmax(0,1fr)}
    }

    .panel{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow)}
    .left{display:flex; flex-direction:column; gap:var(--space); padding:var(--space)}
    .right{display:grid; grid-template-rows: auto 1fr; gap:var(--space); min-height: 50dvh}

    h1{font-size:var(--text-lg); margin:0; letter-spacing:.2px; display:flex; align-items:center; gap:10px}
    .pill{font-size:var(--text-sm); padding:6px 10px; background: rgba(255,255,255,.06); border-radius:999px; border:1px solid rgba(255,255,255,.08)}
    .sub{font-size:var(--text-sm); color:var(--muted)}
    .section{background: var(--panel); border-radius: 12px; padding:var(--space); box-shadow: inset 0 1px 0 rgba(255,255,255,.03), 0 6px 16px rgba(0,0,0,.25)}

    .button{display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03)); color:var(--text); cursor:pointer; transition:.2s transform, .25s box-shadow, .2s background; text-decoration:none; user-select:none; font-size:var(--text-md); min-height:44px}
    .button:hover{transform: translateY(-1px); box-shadow: 0 8px 24px rgba(0,0,0,.35)}
    .button:active{transform: translateY(0)}
    .button.primary{background: linear-gradient(180deg, rgba(124,242,211,.35), rgba(124,242,211,.12)); border-color: rgba(124,242,211,.55)}
    .button.warn{background: linear-gradient(180deg, rgba(255,191,105,.35), rgba(255,191,105,.12)); border-color: rgba(255,191,105,.55)}
    .button.danger{background: linear-gradient(180deg, rgba(255,107,107,.35), rgba(255,107,107,.12)); border-color: rgba(255,107,107,.55)}
    .button.ghost{background: transparent}

    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:8px}

    .file-drop{border:1.5px dashed rgba(255,255,255,.2); border-radius:12px; padding:14px; text-align:center; color:var(--muted); transition:.2s}
    .file-drop.drag{border-color: var(--brand); color:var(--brand); background: rgba(124,242,211,.06)}

    input[type="file"]{display:none}
    select, input[type="text"], input[type="number"], textarea{ width:100%; padding:12px; background: #0e1430; color: var(--text); border:1px solid rgba(255,255,255,.1); border-radius:10px; outline: none; transition:.2s border; font-size:var(--text-md)}
    select:focus, input:focus, textarea:focus{ border-color: var(--accent)}

    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#111a39; border:1px solid rgba(255,255,255,.08); padding:2px 6px; border-radius:6px}
    .grid{display:grid; grid-template-columns: 1fr; gap:10px}
    @media (min-width:680px){ .grid{grid-template-columns: repeat(2, 1fr)} }

    .video-wrap{position:relative; width:100%; aspect-ratio: 16 / 9; border-radius: 12px; overflow:hidden; background: #0a0f24; border:1px solid rgba(255,255,255,.06)}
    @media (min-width: 1200px){ .video-wrap{aspect-ratio: 21 / 9} }
    video{width:100%; height:100%; object-fit:cover; filter: saturate(1.08) contrast(1.05)}
    .scan-status{position:absolute; left:12px; bottom:12px; display:flex; gap:8px; align-items:center}
    .pulse{width:10px; height:10px; border-radius:50%; background: var(--warn); box-shadow:0 0 0 0 rgba(255,191,105,.5); animation: pulse 1.6s infinite}
    .pulse.on{background: var(--brand); box-shadow:0 0 0 0 rgba(124,242,211,.5)}
    @keyframes pulse{0%{transform:scale(.9); box-shadow:0 0 0 0 rgba(255,255,255,.3)} 70%{transform:scale(1); box-shadow:0 0 0 16px rgba(255,255,255,0)} 100%{box-shadow:0 0 0 0 rgba(255,255,255,0)}}

    .card{background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00)); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:var(--space); box-shadow: var(--shadow)}

    /* Bloque resultado adaptable */
    .result{display:grid; grid-template-columns: 1fr; gap:var(--space)}
    @media (min-width:1200px){ .result{grid-template-columns: 1.1fr .9fr} }
    .details{display:flex; flex-direction:column; gap:10px; overflow:auto; max-height: 42dvh}
    .details table{width:100%; border-collapse: collapse}
    .details th, .details td{font-size:var(--text-sm); text-align:left; padding:8px 8px; border-bottom:1px solid rgba(255,255,255,.06)}
    .details tr:hover{background: rgba(255,255,255,.03)}

    .chip{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:var(--text-sm); border:1px solid rgba(255,255,255,.1)}
    .chip.ok{background: rgba(56,217,150,.12); border-color: rgba(56,217,150,.45)}
    .chip.bad{background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.45)}

    .log{overflow:auto; max-height: 60dvh}
    .log table{width:100%; border-collapse: collapse}
    .log th, .log td{font-size:var(--text-sm); padding:8px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left}
    .log tr.added{animation: glow .9s ease-out}
    @keyframes glow{0%{background: rgba(124,242,211,.22)} 100%{background: transparent}}

    .tip{font-size:var(--text-sm); color:var(--muted)}
    .tip.status{transition:color .2s ease}
    .tip.status.success{color:var(--ok)}
    .tip.status.error{color:var(--danger)}
    .tip.status.warn{color:var(--warn)}
    .hidden{display:none}

    /* Barra fija de acciones en m√≥vil */
    .mobile-actions{position:sticky; bottom:0; display:flex; gap:10px; padding-top:10px; background: linear-gradient(180deg, transparent, rgba(0,0,0,.35));}
    @media (min-width:980px){ .mobile-actions{display:none} }

    /* Accesibilidad: reduce motion */
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important; transition:none!important}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: Controles (columna) -->
    <aside class="panel left">
      <div class="row">
        <h1>
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 2l2.3 4.7L19 7.3l-3.5 3.4.8 4.9L12 13.8l-4.3 1.8.8-4.9L5 7.3l4.7-.6L12 2z" stroke="url(#g1)" stroke-width="1.2"/>
            <defs><linearGradient id="g1" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#7cf2d3"/><stop offset="1" stop-color="#9aa8ff"/></linearGradient></defs>
          </svg>
          Mini App Inventario
        </h1>
        <span class="pill" id="invCount" aria-live="polite">0 √≠tems</span>
      </div>

      <!-- Carga Inventario -->
      <section class="section stack" aria-label="Carga de inventario">
        <div class="row">
          <strong>Archivo (CSV / XLSX)</strong>
          <label class="button ghost" for="fileInput">Seleccionar</label>
          <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" />
        </div>
        <div id="drop" class="file-drop" tabindex="0">Arrastr√° y solt√° el archivo aqu√≠</div>
        <div class="grid">
          <div class="stack">
            <label>Columna clave</label>
            <select id="keySelect"></select>
          </div>
          <div class="stack">
            <label>Filtro r√°pido</label>
            <input id="filterInput" type="text" placeholder="Buscar en inventario" />
          </div>
        </div>
        <div class="tip status" id="autoLoadMsg" aria-live="polite"></div>
        <div class="tip">Sugerencia: para uso 100% offline, prefer√≠ CSV (el soporte Excel usa un script CDN).</div>
      </section>

      <!-- Esc√°ner -->
      <section class="section stack" aria-label="Esc√°ner de c√≥digos">
        <div class="row" style="gap:10px">
          <strong>Esc√°ner</strong>
          <span class="chip" id="apiStatus">API: detectando‚Ä¶</span>
        </div>
        <div class="row" style="gap:8px">
          <button class="button primary" id="startBtn">Iniciar c√°mara</button>
          <button class="button warn" id="stopBtn" disabled>Detener</button>
          <button class="button" id="flashBtn" disabled>Flash</button>
          <button class="button" id="switchBtn" disabled>Cambiar</button>
        </div>
        <div class="stack">
          <label>Ingreso manual</label>
          <div class="row" style="gap:8px">
            <input id="manualInput" type="text" placeholder="Peg√° o escrib√≠ un c√≥digo y Enter" />
            <button class="button" id="manualBtn">OK</button>
          </div>
          <div class="tip">Atajo: <span class="kbd">Enter</span> confirma. <span class="kbd">Ctrl/Cmd + C</span> conforma.</div>
        </div>
        <div class="mobile-actions">
          <button class="button primary" id="confirmBtnMobile" disabled>Conformar</button>
          <button class="button" id="exportBtnMobile">Descargar CSV</button>
        </div>
      </section>

      <!-- Exportaci√≥n -->
      <section class="section row" aria-label="Acciones">
        <button class="button primary" id="exportBtn">Descargar "conformado.csv"</button>
        <button class="button danger" id="clearBtn">Limpiar conformados</button>
      </section>

      <div class="sub">Hecho con ‚ù§Ô∏è para flujos r√°pidos en dep√≥sito y control.</div>
    </aside>

    <!-- RIGHT: Esc√°ner + resultados -->
    <main class="right">
      <!-- Video/Scanner Panel -->
      <div class="panel video-wrap">
        <video id="video" playsinline muted></video>
        <div class="scan-status">
          <div id="pulse" class="pulse" aria-hidden="true"></div>
          <span id="scanLabel" class="pill">C√°mara inactiva</span>
        </div>
      </div>

      <!-- Results + Log -->
      <div class="panel" style="display:grid; grid-template-columns: 1fr; gap:var(--space); padding:var(--space)">
        <div class="result">
          <div class="card details">
            <div class="row">
              <strong>Detalles del c√≥digo</strong>
              <span id="matchChip" class="chip" aria-live="polite">‚Äî</span>
            </div>
            <div class="stack">
              <div class="row">
                <div class="stack" style="flex:1; min-width: 200px">
                  <label>C√≥digo detectado</label>
                  <input id="detectedCode" type="text" readonly />
                </div>
                <div class="stack" style="width:min(340px, 100%)">
                  <label>Acci√≥n</label>
                  <div class="row" style="gap:8px">
                    <button class="button primary" id="confirmBtn" disabled>Marcar como conformado</button>
                    <button class="button ghost" id="copyBtn" title="Copiar c√≥digo" disabled>Copiar</button>
                  </div>
                </div>
              </div>
              <div id="detailTableWrap" class="stack">
                <label>Informaci√≥n asociada</label>
                <div class="tip" id="noData">Carg√° un inventario y eleg√≠ la columna clave para ver detalles.</div>
                <div id="detailTable" class="hidden">
                  <table id="detailTbl"></table>
                </div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="row">
              <strong>Inventario (vista r√°pida)</strong>
              <span class="pill" id="visibleCount">0 visibles</span>
            </div>
            <div class="details" style="max-height: 28dvh">
              <table id="invTbl"></table>
            </div>
          </div>
        </div>
        <div class="card log">
          <div class="row">
            <strong>Conformados</strong>
            <span class="pill" id="confCount">0</span>
          </div>
          <table id="confTbl"></table>
        </div>
      </div>

      <!-- Pruebas integradas -->
      <div class="panel section" style="margin-top:var(--space)">
        <details>
          <summary>üß™ Pruebas r√°pidas (CSV/Export) ‚Äì abrir para ejecutar</summary>
          <div class="stack" style="margin-top:10px">
            <button class="button" id="btnTestCSV">Test parser CSV</button>
            <button class="button" id="btnTestExport">Test export CSV</button>
            <div class="tip">Los resultados se muestran en la consola del navegador y/o como descarga de un archivo de prueba.</div>
          </div>
        </details>
      </div>

    </main>
  </div>

  <!-- Script principal -->
  <script>
  const state = {
    inventory: [],
    columns: [],
    key: null,
    index: new Map(),
    conformados: [],
    cameraDevices: [],
    currentDeviceId: null,
    scanning: false,
    detector: null,
    fallbackReader: null,
    fallbackErrorShown: false,
    torchOn: false,
    lastScan: { code: null, time: 0 },
    inventoryName: null,
    exportDelimiter: ';',
  };

  // ---- Utilidades UI ----
  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={},{children=[]}={}) => { const n = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==="class") n.className=v; else if(k==="text") n.textContent=v; else n.setAttribute(k,v)}); children.forEach(c=> n.appendChild(c)); return n};
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  function setChip(id, text, ok=null){
    const chip = $(id); chip.textContent = text;
    chip.classList.remove('ok','bad');
    if(ok===true) chip.classList.add('ok');
    if(ok===false) chip.classList.add('bad');
  }

  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    const c = el('canvas',{style:`position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:9999`});
    document.body.appendChild(c);
    const ctx = c.getContext('2d'); c.width=innerWidth; c.height=innerHeight;
    const parts = Array.from({length:120},()=>({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()*-6-3),w:2+Math.random()*3,h:6+Math.random()*6,rot:Math.random()*Math.PI,vr:(Math.random()-0.5)*.2,life:120+Math.random()*60, col:`hsl(${Math.random()*360},90%,70%)`}));
    let tick=0; (function loop(){ ctx.clearRect(0,0,c.width,c.height); parts.forEach(p=>{ p.vy+=.12; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.life--; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.col; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore(); });
      if(++tick<180){ requestAnimationFrame(loop)} else c.remove(); })();
  }

  // ---- CSV Parser (ligero, con autodetecci√≥n de separador) ----
  function stripBom(text){ return text.replace(/^\uFEFF/, ''); }

  function detectDelimiter(text){
    const sample = stripBom(text).split(/\r?\n/).find(line=> line.trim().length) || '';
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = 0;
    for(const delimiter of candidates){
      let count = 0; let inQ = false;
      for(let i=0;i<sample.length;i++){
        const ch = sample[i];
        if(ch==='"'){
          if(inQ && sample[i+1]==='"'){ i++; }
          inQ = !inQ;
        } else if(ch===delimiter && !inQ){ count++; }
      }
      if(count>bestCount){ best = delimiter; bestCount = count; }
    }
    return bestCount>0 ? best : ',';
  }

  function parseCSV(text, delimiter=','){
    const clean = stripBom(text);
    const rows = [];
    let cur = '', row = [], inQ=false;
    for(let i=0;i<clean.length;i++){
      const ch = clean[i], next = clean[i+1];
      if(ch==='"'){
        if(inQ && next==='"'){ cur+='"'; i++; }
        else { inQ = !inQ; }
      } else if(ch===delimiter && !inQ){
        row.push(cur); cur='';
      } else if((ch==='\n' || ch==='\r') && !inQ){
        if(ch==='\r' && next==='\n'){ i++; }
        if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
      } else {
        cur+=ch;
      }
    }
    if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  function parseCSVAuto(text){
    const delimiter = detectDelimiter(text);
    const rows = parseCSV(text, delimiter).filter(r=> r.length && r.some(c=> String(c ?? '').trim()!==''));
    return { rows, delimiter };
  }

  // ---- Lectura de archivos ----
  async function loadFile(file){
    if(!file) return;
    try{
      const name = file.name;
      const lower = name.toLowerCase();
      if(lower.endsWith('.csv')){
        const text = await file.text();
        const {rows, delimiter} = parseCSVAuto(text);
        hydrateInventory(rows, { name, delimiter });
      } else if(lower.endsWith('.xlsx') || lower.endsWith('.xls')){
        await ensureSheetJS();
        if(!window.XLSX){
          alert('No se pudo cargar el lector de Excel. Export√° a CSV y volv√© a intentar.');
          setInventoryStatus('No se pudo cargar el lector de Excel. Prefer√≠ CSV para uso offline.', 'warn');
          return;
        }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
        hydrateInventory(rows, { name });
      } else {
        alert('Formato no soportado. Us√° CSV o Excel (.xlsx).');
        setInventoryStatus('Formato no soportado. Seleccion√° un CSV o Excel.', 'error');
      }
    }catch(err){
      console.error('Error al leer archivo', err);
      alert('Ocurri√≥ un problema al leer el archivo seleccionado. Verific√° el formato e intent√° nuevamente.');
      setInventoryStatus('No se pudo cargar el archivo seleccionado.', 'error');
    }
  }

  function uniqueColumnNames(rawHeader){
    const seen = new Set();
    return rawHeader.map((name, idx)=>{
      let base = String(name ?? '').replace(/\uFEFF/g,'').trim();
      if(!base){ base = `col_${idx+1}`; }
      let final = base;
      let counter = 2;
      while(seen.has(final)){
        final = `${base}_${counter++}`;
      }
      seen.add(final);
      return final;
    });
  }

  function normalizeRowValue(value){
    if(value===null || value===undefined) return '';
    if(typeof value === 'string') return value.replace(/\uFEFF/g,'').trim();
    return String(value);
  }

  function setInventoryStatus(text='', tone='info'){
    const msg = $('#autoLoadMsg');
    if(!msg) return;
    msg.textContent = text;
    msg.classList.remove('success','error','warn');
    if(tone==='success') msg.classList.add('success');
    else if(tone==='error') msg.classList.add('error');
    else if(tone==='warn') msg.classList.add('warn');
  }

  function hydrateInventory(rows, {name='inventario', delimiter}={}){
    if(!rows.length){
      alert('El archivo est√° vac√≠o.');
      setInventoryStatus('El archivo no contiene registros.', 'error');
      return;
    }
    const [header, ...data] = rows;
    state.columns = uniqueColumnNames(header);
    state.inventory = data
      .filter(r=> Array.isArray(r) && r.some(c=> String(c ?? '').trim()!==''))
      .map(r=> Object.fromEntries(state.columns.map((c,i)=>[c, normalizeRowValue(r[i])] )));
    if(!state.columns.length){
      setInventoryStatus('No se detectaron columnas en el archivo.', 'error');
      return;
    }
    state.inventoryName = name;
    if(delimiter){ state.exportDelimiter = delimiter; }
    $('#filterInput').value = '';
    // Detectar columna probable de c√≥digo
    const lc = state.columns.map(c=>c.toLowerCase());
    const guess = ['codigo','c√≥digo','barcode','barra','ean','sku','id','inventario','cod_barra','code','nro.inventario']
      .find(k=> lc.includes(k));
    state.key = guess || state.columns[0];
    rebuildIndex();
    paintInventory();
    fillKeySelect();
    paintConformados();
    $('#invCount').textContent = `${state.inventory.length} √≠tems`;
    setInventoryStatus(`Inventario cargado${name?` (${name})`:''}: ${state.inventory.length} √≠tems disponibles.`, 'success');
  }

  function rebuildIndex(){
    state.index = new Map();
    if(!state.columns.includes(state.key)){
      state.key = state.columns[0] || null;
    }
    if(!state.key) return;
    for(const row of state.inventory){
      const code = String(row[state.key] ?? '').trim();
      if(code) state.index.set(code, row);
    }
  }

  function fillKeySelect(){
    const sel = $('#keySelect'); sel.innerHTML = '';
    state.columns.forEach(c=> sel.appendChild(el('option',{value:c, text:c})));
    sel.disabled = state.columns.length===0;
    sel.value = state.key || '';
  }

  function paintInventory(){
    const tbl = $('#invTbl'); tbl.innerHTML = '';
    if(!state.columns.length){
      const tr = el('tr');
      const td = el('td',{text:'Carg√° un inventario para ver la vista previa.'});
      td.colSpan = 1;
      tr.appendChild(td);
      tbl.appendChild(tr);
      $('#visibleCount').textContent = '0 visibles';
      return;
    }
    const head = el('tr');
    const cols = state.columns.slice(0, 6);
    cols.forEach(c=> head.appendChild(el('th',{text:c})));
    tbl.appendChild(head);
    const filter = $('#filterInput').value.toLowerCase();
    let visible = 0;
    for(const row of state.inventory){
      const line = cols.map(c=> String(row[c]??'')).join(' ').toLowerCase();
      if(filter && !line.includes(filter)) continue;
      visible++;
      const tr = el('tr');
      cols.forEach(c=> tr.appendChild(el('td',{text:String(row[c]??'')})));
      tbl.appendChild(tr);
    }
    $('#visibleCount').textContent = `${visible} visibles`;
  }

  // ---- C√°mara y BarcodeDetector ----
  async function initDevices(){
    try{
      const devs = await navigator.mediaDevices.enumerateDevices();
      state.cameraDevices = devs.filter(d=> d.kind==='videoinput');
      $('#switchBtn').disabled = state.cameraDevices.length<2;
    }catch(e){ console.warn(e); }
  }

  async function startCamera(){
    try{
      const videoConstraints = { width:{ideal:1280}, height:{ideal:720}, facingMode:'environment' };
      if(state.currentDeviceId){
        delete videoConstraints.facingMode;
        videoConstraints.deviceId = { exact: state.currentDeviceId };
      }
      const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints });
      const v = $('#video'); v.srcObject = stream; await v.play();
      const track = stream.getVideoTracks?.()[0];
      state.currentDeviceId = track?.getSettings?.().deviceId || state.currentDeviceId;
      $('#pulse').classList.add('on'); $('#scanLabel').textContent = 'Escaneando‚Ä¶';
      $('#startBtn').disabled = true; $('#stopBtn').disabled = false;
      $('#flashBtn').textContent = 'Flash';
      state.torchOn = false;
      let torchAvailable = !!track;
      const caps = track?.getCapabilities?.();
      if(track && caps && ('torch' in caps)){
        torchAvailable = !!caps.torch;
      }
      $('#flashBtn').disabled = !torchAvailable;
      state.scanning = true;
      state.detector = null;
      if(state.fallbackReader?.reset) state.fallbackReader.reset();
      state.fallbackReader = null;
      state.fallbackErrorShown = false;
      _lastDetectTs = 0;
      if(!('BarcodeDetector' in window)){
        const ZX = await ensureZXing();
        if(ZX && ZX.BrowserMultiFormatReader){
          state.fallbackReader = new ZX.BrowserMultiFormatReader();
          if('timeBetweenDecodingAttempts' in state.fallbackReader){
            state.fallbackReader.timeBetweenDecodingAttempts = DETECT_EVERY_MS;
          }
          if('timeBetweenScansMillis' in state.fallbackReader){
            state.fallbackReader.timeBetweenScansMillis = DETECT_EVERY_MS;
          }
          setChip('#apiStatus','API: ZXing (fallback)', true);
        } else {
          setChip('#apiStatus','API: no disponible (sin ZXing)', false);
          if(!state.fallbackErrorShown){
            alert('Este navegador no soporta BarcodeDetector y no se pudo cargar la librer√≠a ZXing. Us√° el ingreso manual.');
            state.fallbackErrorShown = true;
          }
          stopCamera();
          return;
        }
      }
      await initDevices();
      detectLoop();
    }catch(e){ alert('No se pudo acceder a la c√°mara. Revis√° permisos.'); console.error(e); }
  }

  function stopCamera(){
    const v = $('#video');
    const s = v.srcObject;
    if(s){ s.getTracks().forEach(t=>t.stop()); v.srcObject=null; }
    $('#pulse').classList.remove('on'); $('#scanLabel').textContent = 'C√°mara inactiva';
    $('#startBtn').disabled = false; $('#stopBtn').disabled = true;
    $('#flashBtn').disabled = true; $('#flashBtn').textContent = 'Flash';
    state.torchOn = false;
    state.scanning = false;
    state.detector = null;
    if(state.fallbackReader?.reset) state.fallbackReader.reset();
    state.fallbackReader = null;
  }

  async function toggleTorch(){
    const track = $('#video').srcObject?.getVideoTracks?.()[0];
    if(!track) return;
    const caps = track.getCapabilities?.()||{}; if(!caps.torch){ return alert('El flash no est√° disponible en este dispositivo.'); }
    state.torchOn = !state.torchOn;
    await track.applyConstraints({ advanced: [{ torch: state.torchOn }] });
    $('#flashBtn').textContent = state.torchOn? 'Flash (ON)' : 'Flash';
  }

  async function switchCamera(){
    if(state.cameraDevices.length<2) return;
    const idx = state.cameraDevices.findIndex(d=> d.deviceId===state.currentDeviceId);
    const next = state.cameraDevices[(idx+1) % state.cameraDevices.length];
    state.currentDeviceId = next.deviceId; stopCamera(); startCamera();
  }

  // Throttle de detecci√≥n para mejorar rendimiento en m√≥vil
  let _lastDetectTs = 0;
  const DETECT_EVERY_MS = 250;

  async function detectLoop(){
    if(!state.scanning) return;
    try{
      const video = $('#video');
      const now = performance.now();

      if(state.detector){
        if((now - _lastDetectTs) > DETECT_EVERY_MS && video.readyState >= 2){
          _lastDetectTs = now;
          try{
            const bitmap = await createImageBitmap(video);
            const codes = await state.detector.detect(bitmap);
            bitmap.close?.();
            if(codes && codes.length && state.scanning){
              const first = codes[0];
              onDetect(first.rawValue || first.displayValue);
            }
          }catch(err){
            console.warn('Error detectando con BarcodeDetector', err);
          }
        }
      } else if('BarcodeDetector' in window && !state.fallbackReader){
        try{
          const formats = ['code_128','ean_13','ean_8','upc_a','upc_e','code_39','code_93','itf','codabar','qr_code','data_matrix','pdf417'];
          state.detector = new BarcodeDetector({formats});
          setChip('#apiStatus','API: BarcodeDetector', true);
          _lastDetectTs = 0;
        }catch(err){
          console.warn('BarcodeDetector no disponible, usando ZXing', err);
          state.detector = null;
        }
      }

      if(!state.detector){
        if(!state.fallbackReader){
          const ZX = await ensureZXing();
          if(ZX && ZX.BrowserMultiFormatReader){
            state.fallbackReader = new ZX.BrowserMultiFormatReader();
            if('timeBetweenDecodingAttempts' in state.fallbackReader){
              state.fallbackReader.timeBetweenDecodingAttempts = DETECT_EVERY_MS;
            }
            if('timeBetweenScansMillis' in state.fallbackReader){
              state.fallbackReader.timeBetweenScansMillis = DETECT_EVERY_MS;
            }
            setChip('#apiStatus','API: ZXing (fallback)', true);
            state.fallbackErrorShown = false;
            _lastDetectTs = 0;
          } else {
            setChip('#apiStatus','API: no disponible (sin ZXing)', false);
            if(!state.fallbackErrorShown){
              alert('Este navegador no soporta BarcodeDetector y no se pudo cargar la librer√≠a ZXing. Us√° el ingreso manual.');
              state.fallbackErrorShown = true;
            }
            stopCamera();
            return;
          }
        }
        if(state.fallbackReader && (now - _lastDetectTs) > DETECT_EVERY_MS && video.readyState >= 2){
          _lastDetectTs = now;
          try{
            const result = await state.fallbackReader.decodeFromVideoElement(video);
            const text = result?.text || result?.getText?.();
            if(text && state.scanning){ onDetect(text); }
          }catch(err){
            const ZX = window.ZXing;
            const name = err?.name;
            if(ZX && (err instanceof ZX.NotFoundException || err instanceof ZX.ChecksumException || err instanceof ZX.FormatException)){
              // Errores esperados cuando no hay c√≥digo en el frame
            } else if(name && ['NotFoundException','ChecksumException','FormatException'].includes(name)){
              // Errores esperados sin ZXing global disponible
            } else if(err?.message?.includes('No MultiFormat Readers were able to detect')){
              // ZXing no encontr√≥ c√≥digo en este frame
            } else {
              console.warn('Error detectando con ZXing', err);
            }
          }
        }
      }
    }catch(err){
      console.warn('detectLoop error', err);
    }
    requestAnimationFrame(detectLoop);
  }

  function onDetect(code){
    code = String(code||'').trim(); if(!code) return;
    // Anti-rebote: evita repetir el mismo c√≥digo por 3s
    const now = Date.now();
    if(state.lastScan.code===code && (now - state.lastScan.time) < 3000) return;
    state.lastScan = { code, time: now };

    $('#detectedCode').value = code; $('#copyBtn').disabled = false; $('#confirmBtn').disabled = false; $('#confirmBtnMobile').disabled = false;
    const row = state.index.get(code);
    if(row){
      setChip('#matchChip','Coincide en inventario', true);
      paintDetails(row);
      flashOK();
    } else {
      setChip('#matchChip','No encontrado en inventario', false);
      clearDetails();
      flashWarn();
    }
  }

  function paintDetails(row){
    $('#noData').classList.add('hidden'); $('#detailTable').classList.remove('hidden');
    const tbl = $('#detailTbl'); tbl.innerHTML='';
    for(const c of state.columns){
      const tr = el('tr'); tr.appendChild(el('th',{text:c})); tr.appendChild(el('td',{text:String(row[c]??'')})); tbl.appendChild(tr);
    }
  }
  function clearDetails(){ $('#detailTbl').innerHTML=''; $('#detailTable').classList.add('hidden'); $('#noData').classList.remove('hidden'); }

  function flashOK(){
    const card = document.querySelector('.details'); card.style.boxShadow='0 0 0 2px rgba(56,217,150,.5)'; setTimeout(()=> card.style.boxShadow='', 320);
  }
  function flashWarn(){
    const card = document.querySelector('.details'); card.style.boxShadow='0 0 0 2px rgba(255,191,105,.6)'; setTimeout(()=> card.style.boxShadow='', 320);
  }

  function addConformado(code){
    const ts = new Date().toISOString();
    const row = state.index.get(String(code)) || null;
    // Evitar duplicados exactos por c√≥digo
    if(state.conformados.some(x=> x.codigo===code)) return;
    const rec = { codigo: code, timestamp: ts };
    if(row){ for(const c of state.columns){ rec[c] = row[c]??''; } rec._match = '1'; }
    else { rec._match = '0'; }
    state.conformados.unshift(rec);
    persistConformados();
    paintConformados();
    confetti(window.innerWidth-180, 140);
  }

  function paintConformados(){
    const tbl = $('#confTbl'); tbl.innerHTML='';
    const cols = ['timestamp','codigo','_match', ...state.columns.slice(0,4)];
    const head = el('tr'); cols.forEach(c=> head.appendChild(el('th',{text:c}))); tbl.appendChild(head);
    for(const rec of state.conformados){
      const tr = el('tr'); tr.classList.add('added');
      cols.forEach(c=> tr.appendChild(el('td',{text:String(rec[c]??'')})));
      tbl.appendChild(tr);
    }
    $('#confCount').textContent = state.conformados.length;
  }

  function exportCSV(){
    if(!state.conformados.length){ alert('No hay registros para exportar.'); return; }
    const cols = Array.from(new Set(['timestamp','codigo','_match', ...state.columns]));
    const esc=v=> '"'+String(v??'').replace(/"/g,'""')+'"';
    const delim = state.exportDelimiter || ',';
    const lines = [cols.map(esc).join(delim)];
    state.conformados.forEach(rec=>{ lines.push(cols.map(c=> esc(rec[c])).join(delim)); });
    const blob = new Blob(['\uFEFF'+lines.join('\r\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = el('a',{href:url, download:'conformado.csv'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function persistConformados(){
    try{ localStorage.setItem('conformados_v1', JSON.stringify(state.conformados)); }catch{}
  }
  function restoreConformados(){
    try{ const v = JSON.parse(localStorage.getItem('conformados_v1')||'[]'); if(Array.isArray(v)) state.conformados = v; }catch{}
    paintConformados();
  }

  async function ensureSheetJS(){
    if(window.XLSX) return;
    await new Promise((resolve)=>{
      const s = document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; s.onload=resolve; s.onerror=resolve; document.head.appendChild(s);
    });
  }

  let ensureZXingPromise = null;
  async function ensureZXing(){
    if(window.ZXing && window.ZXing.BrowserMultiFormatReader) return window.ZXing;
    if(ensureZXingPromise) return ensureZXingPromise;
    ensureZXingPromise = new Promise((resolve)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js';
      s.onload = ()=> resolve(window.ZXing || null);
      s.onerror = ()=> resolve(null);
      document.head.appendChild(s);
    });
    const lib = await ensureZXingPromise;
    if(!lib || !lib.BrowserMultiFormatReader){
      ensureZXingPromise = null;
      return null;
    }
    return lib;
  }

  // ---- Eventos ----
  async function loadDefaultInventory(){
    try{
      const res = await fetch('inventario.csv', {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if(!text.trim()) throw new Error('Archivo vac√≠o');
      const {rows, delimiter} = parseCSVAuto(text);
      hydrateInventory(rows, { name: 'inventario.csv', delimiter });
    }catch(err){
      console.info('Inventario autom√°tico no disponible:', err);
      const manualMsg = location.protocol === 'file:'
        ? 'Abr√≠ este archivo desde un servidor o seleccion√° el inventario manualmente.'
        : 'Seleccion√° un archivo usando el bot√≥n "Seleccionar" o arrastralo al recuadro.';
      setInventoryStatus(manualMsg, 'warn');
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    restoreConformados();
    await initDevices();
    setInventoryStatus('Buscando inventario predeterminado‚Ä¶', 'info');
    loadDefaultInventory();
    $('#keySelect').addEventListener('change', e=>{ state.key = e.target.value; rebuildIndex(); });
    $('#filterInput').addEventListener('input', paintInventory);

    // Drag & drop
    const drop = $('#drop');
    const handleLoad = e=>{ e.preventDefault(); drop.classList.remove('drag'); const f = (e.dataTransfer||{}).files?.[0]; if(f) loadFile(f); };
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', handleLoad);

    // Tambi√©n click / Enter sobre el √°rea de drop
    drop.addEventListener('click', ()=> $('#fileInput').click());
    drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); $('#fileInput').click(); } });

    // File input
    $('#fileInput').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) loadFile(f); e.target.value=''; });

    // Scanner
    $('#startBtn').addEventListener('click', startCamera);
    $('#stopBtn').addEventListener('click', stopCamera);
    $('#flashBtn').addEventListener('click', toggleTorch);
    $('#switchBtn').addEventListener('click', switchCamera);

    // Manual input
    const manual = ()=>{ const v = $('#manualInput').value.trim(); if(!v) return; onDetect(v); $('#manualInput').value=''; };
    $('#manualBtn').addEventListener('click', manual);
    $('#manualInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manual(); });

    // Actions
    const confirmAction = ()=>{ const code = $('#detectedCode').value; if(!code) return; addConformado(code); };
    $('#confirmBtn').addEventListener('click', confirmAction);
    $('#confirmBtnMobile').addEventListener('click', confirmAction);
    $('#copyBtn').addEventListener('click', ()=>{ const code=$('#detectedCode').value; if(code) navigator.clipboard.writeText(code); });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#exportBtnMobile').addEventListener('click', exportCSV);
    $('#clearBtn').addEventListener('click', ()=>{ if(confirm('¬øVaciar la lista de conformados?')){ state.conformados=[]; persistConformados(); paintConformados(); }});

    // Atajo global para confirmar r√°pido
    document.addEventListener('keydown', e=>{ if(e.key==='c' && (e.ctrlKey||e.metaKey)) $('#confirmBtn').click(); });

    // ===== Pruebas =====
    $('#btnTestCSV').addEventListener('click', ()=>{
      const sample = 'codigo,desc,qty\r\n123,Item A,5\r\n"124,7",Item B,10\r\n125,"Item, C",0\r\n';
      const parsedA = parseCSVAuto(sample);
      console.assert(parsedA.rows.length===4, 'CSV coma: 4 filas contando header');
      console.assert(parsedA.rows[2][0]==='124,7', 'CSV coma: campo con coma entre comillas');

      const sampleB = '\uFEFFcodigo;desc;qty\n001;Item A;5\n002;"Item; B";3\n';
      const parsedB = parseCSVAuto(sampleB);
      console.assert(parsedB.delimiter===';', 'CSV punto y coma detectado');
      console.assert(parsedB.rows[2][1]==='Item; B', 'CSV punto y coma respeta comillas internas');

      console.log('‚úÖ Test CSV OK', {coma: parsedA, puntoYComa: parsedB});
    });

    $('#btnTestExport').addEventListener('click', ()=>{
      state.columns = ['codigo','desc'];
      state.exportDelimiter = ';';
      state.conformados = [
        {timestamp:'2025-10-22T12:00:00Z', codigo:'ABC', _match:'1', desc:'Algo'},
        {timestamp:'2025-10-22T12:01:00Z', codigo:'XYZ', _match:'0', desc:'Otra'}
      ];
      exportCSV();
      console.log('‚úÖ Test export OK (deber√≠as ver un archivo descargado)');
    });
  });
  </script>
</body>
</html>
