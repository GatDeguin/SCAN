<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan Control · Inventario ágil</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #05070f;
      --bg-soft: #0b1020;
      --surface: #11182d;
      --surface-high: rgba(21, 30, 54, 0.9);
      --border: rgba(120, 148, 255, 0.22);
      --text: #eef2ff;
      --text-soft: rgba(227, 233, 255, 0.72);
      --accent: #7cf1d4;
      --accent-strong: #53c2ff;
      --danger: #ff6b81;
      --warn: #ffb347;
      --success: #5dec9a;
      --radius-xl: 28px;
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --space-xs: 6px;
      --space-sm: 12px;
      --space-md: 18px;
      --space-lg: 28px;
      --space-xl: 42px;
      --shadow-soft: 0 18px 38px rgba(5, 8, 20, 0.6);
      --shadow-strong: 0 22px 60px rgba(5, 8, 20, 0.7);
      --font-xs: clamp(11px, 1.4vw, 12px);
      --font-sm: clamp(12px, 1.6vw, 14px);
      --font-md: clamp(14px, 2vw, 16px);
      --font-lg: clamp(18px, 3.4vw, 22px);
      --font-xl: clamp(26px, 5vw, 34px);
      --transition: 180ms ease;
    }

    @media (prefers-color-scheme: light) {
      :root {
        color-scheme: light;
        --bg: #f4f6ff;
        --bg-soft: #edf0ff;
        --surface: rgba(255, 255, 255, 0.82);
        --surface-high: rgba(255, 255, 255, 0.9);
        --border: rgba(90, 112, 180, 0.18);
        --text: #0f172a;
        --text-soft: rgba(15, 23, 42, 0.65);
        --shadow-soft: 0 16px 30px rgba(15, 23, 42, 0.12);
        --shadow-strong: 0 32px 60px rgba(15, 23, 42, 0.16);
      }
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(1400px 900px at -10% 0%, rgba(124, 241, 212, 0.08), transparent 60%),
                  radial-gradient(1200px 720px at 110% 6%, rgba(83, 194, 255, 0.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    a { color: inherit; }

    .app {
      min-height: 100dvh;
      max-width: 1240px;
      margin: 0 auto;
      padding: clamp(20px, 5vw, 48px) clamp(16px, 6vw, 60px) clamp(90px, 10vw, 120px);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }

    .surface {
      background: var(--surface-high);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(32px);
      -webkit-backdrop-filter: blur(32px);
    }

    .header {
      padding: clamp(18px, 3vw, 32px);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-md);
    }

    .brand {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
      min-width: 0;
    }

    .brand-logo {
      width: clamp(44px, 8vw, 58px);
      height: clamp(44px, 8vw, 58px);
      border-radius: 22px;
      background: linear-gradient(135deg, rgba(124, 241, 212, 0.8), rgba(83, 194, 255, 0.75));
      display: grid;
      place-items: center;
      color: #041a18;
      font-weight: 700;
      letter-spacing: 0.02em;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45);
    }

    .brand h1 {
      margin: 0;
      font-size: var(--font-xl);
      letter-spacing: -0.02em;
    }

    .brand p {
      margin: 4px 0 0;
      color: var(--text-soft);
      font-size: var(--font-sm);
    }

    .header-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      font-size: var(--font-sm);
      color: inherit;
    }

    .badge-muted {
      color: var(--text-soft);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .badge.ok {
      border-color: rgba(93, 236, 154, 0.6);
      background: rgba(93, 236, 154, 0.18);
      color: #052716;
    }

    .badge.bad {
      border-color: rgba(255, 107, 129, 0.6);
      background: rgba(255, 107, 129, 0.2);
      color: #30040f;
    }

    .layout {
      display: grid;
      gap: var(--space-lg);
    }

    @media (min-width: 1100px) {
      .layout {
        grid-template-columns: minmax(340px, 360px) minmax(0, 1fr);
      }
    }

    .panel {
      padding: clamp(18px, 3vw, 30px);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: var(--font-lg);
      font-weight: 600;
    }

    .panel p {
      margin: 0;
      font-size: var(--font-sm);
      color: var(--text-soft);
    }

    .control-grid {
      display: grid;
      gap: var(--space-md);
    }

    .control-group {
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      background: rgba(10, 16, 32, 0.65);
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }

    .button {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.06);
      border-radius: var(--radius-sm);
      color: inherit;
      font-size: var(--font-md);
      font-weight: 600;
      padding: 12px 18px;
      min-height: 46px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition), border var(--transition);
    }

    .button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
    }

    .button.primary {
      background: linear-gradient(135deg, rgba(124, 241, 212, 0.32), rgba(83, 194, 255, 0.24));
      border-color: rgba(124, 241, 212, 0.45);
      color: #06221a;
    }

    .button.warn {
      background: linear-gradient(135deg, rgba(255, 179, 71, 0.35), rgba(255, 213, 102, 0.24));
      border-color: rgba(255, 179, 71, 0.4);
      color: #2a1500;
    }

    .button.danger {
      background: linear-gradient(135deg, rgba(255, 107, 129, 0.32), rgba(255, 152, 173, 0.2));
      border-color: rgba(255, 107, 129, 0.45);
      color: #2b030f;
    }

    .button.ghost {
      background: rgba(255, 255, 255, 0.04);
    }

    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      background: rgba(9, 13, 24, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-sm);
      padding: 12px 14px;
      font-size: var(--font-md);
      color: inherit;
      font-family: inherit;
      transition: border var(--transition), box-shadow var(--transition), background var(--transition);
    }

    input:focus-visible, select:focus-visible, textarea:focus-visible, .button:focus-visible {
      outline: 2px solid var(--accent-strong);
      outline-offset: 2px;
    }

    label {
      font-size: var(--font-sm);
      color: var(--text-soft);
      font-weight: 500;
    }

    .drop-zone {
      position: relative;
      border: 1.6px dashed rgba(255, 255, 255, 0.18);
      border-radius: var(--radius-lg);
      padding: clamp(28px, 5vw, 40px);
      text-align: center;
      color: var(--text-soft);
      background: rgba(14, 18, 30, 0.5);
      transition: color var(--transition), border var(--transition), transform var(--transition), background var(--transition);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
      align-items: center;
      justify-content: center;
    }

    .drop-zone.drag {
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(124, 241, 212, 0.08);
      transform: translateY(-2px);
    }

    .drop-zone strong {
      font-size: var(--font-md);
      color: inherit;
    }

    .workspace {
      display: grid;
      gap: var(--space-md);
    }

    @media (min-width: 900px) {
      .workspace {
        grid-template-columns: minmax(280px, 420px) minmax(0, 1fr);
      }
    }

    .video-shell {
      border-radius: var(--radius-xl);
      overflow: hidden;
      position: relative;
      background: rgba(7, 11, 22, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.08);
      aspect-ratio: 3 / 4;
      display: flex;
    }

    @media (min-width: 720px) {
      .video-shell { aspect-ratio: 16 / 9; }
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(1.08) contrast(1.04);
    }

    .scan-overlay {
      position: absolute;
      inset: 0;
      padding: var(--space-sm);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .scan-top {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-sm);
    }

    .scan-bottom {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .pulse {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--warn);
      box-shadow: 0 0 0 0 rgba(255, 179, 71, 0.5);
      animation: pulse 1.8s ease-in-out infinite;
    }

    .pulse.on {
      background: var(--accent);
      box-shadow: 0 0 0 0 rgba(124, 241, 212, 0.4);
    }

    @keyframes pulse {
      0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.25); }
      60% { transform: scale(1); box-shadow: 0 0 0 16px rgba(255, 255, 255, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }

    .data-panels {
      display: grid;
      gap: var(--space-md);
    }

    .card {
      border-radius: var(--radius-lg);
      background: rgba(10, 14, 26, 0.72);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .card strong { font-size: var(--font-md); }

    .card-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-sm);
    }

    .table-scroll {
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.05);
      max-height: 320px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 100%;
      font-size: var(--font-sm);
    }

    th, td {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      text-align: left;
    }

    th {
      font-weight: 600;
      background: rgba(255, 255, 255, 0.04);
    }

    tr.added {
      animation: rowIn 260ms ease;
    }

    @keyframes rowIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .hidden { display: none !important; }

    .hint {
      font-size: var(--font-sm);
      color: var(--text-soft);
    }

    .kbd {
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
      background: rgba(15, 20, 32, 0.8);
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: var(--font-xs);
    }

    .status {
      font-size: var(--font-sm);
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }
    .status.warn { color: var(--warn); }

    footer {
      text-align: center;
      font-size: var(--font-sm);
      color: var(--text-soft);
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    footer strong { color: var(--text); }

    .drawer {
      position: fixed;
      inset: 0;
      background: rgba(5, 8, 20, 0.7);
      backdrop-filter: blur(28px);
      -webkit-backdrop-filter: blur(28px);
      display: flex;
      justify-content: flex-end;
      padding: clamp(16px, 4vw, 32px);
      z-index: 40;
    }

    .drawer__panel {
      width: min(440px, 100%);
      background: var(--surface-high);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-strong);
      padding: clamp(18px, 3vw, 28px);
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    @media (max-width: 640px) {
      .drawer { justify-content: center; padding: 0; }
      .drawer__panel { width: 100%; border-radius: 0; }
    }

    details {
      border-radius: var(--radius-lg);
      background: rgba(12, 16, 30, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: var(--space-md);
    }

    details summary {
      cursor: pointer;
      list-style: none;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-weight: 600;
    }

    details summary::-webkit-details-marker { display: none; }

    .mobile-actions {
      display: none;
      position: sticky;
      bottom: 0;
      margin-top: auto;
      gap: var(--space-sm);
      padding-top: var(--space-sm);
    }

    @media (max-width: 900px) {
      .mobile-actions { display: flex; flex-direction: column; }
      .button.full { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header surface" aria-label="Estado general">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">SC</div>
        <div>
          <h1>Scan Control</h1>
          <p>Controlá inventarios con cámara o códigos manuales en segundos.</p>
        </div>
      </div>
      <div class="header-metrics">
        <span id="invCount" class="badge" aria-live="polite">0 ítems</span>
        <span id="keyIndicator" class="badge badge-muted" aria-live="polite">Clave: —</span>
      </div>
    </header>

    <div class="layout">
      <section class="panel surface" aria-label="Controles principales">
        <div class="control-grid">
          <article class="control-group">
            <header>
              <h2>Escáner</h2>
              <p>Activa la cámara del dispositivo y detectá códigos al instante.</p>
            </header>
            <div class="status" id="apiStatus">API: detectando…</div>
            <div class="button-row">
              <button class="button primary" id="startBtn" type="button">Iniciar cámara</button>
              <button class="button warn" id="stopBtn" type="button" disabled>Detener</button>
              <button class="button" id="flashBtn" type="button" disabled>Flash</button>
              <button class="button" id="switchBtn" type="button" disabled>Cambiar</button>
            </div>
          </article>

          <article class="control-group">
            <header>
              <h2>Ingreso manual</h2>
              <p>Ideal cuando el código es único o no podés usar la cámara.</p>
            </header>
            <label for="manualInput">Código</label>
            <div class="button-row">
              <input id="manualInput" type="text" placeholder="Ingresá o pegá un código y presioná Enter" aria-label="Ingreso manual" />
              <button class="button" id="manualBtn" type="button">OK</button>
            </div>
            <p class="hint">Atajos: <span class="kbd">Enter</span> confirma · <span class="kbd">Ctrl/Cmd + C</span> conforma de inmediato.</p>
          </article>

          <article class="control-group">
            <header>
              <h2>Inventario</h2>
              <p>Importá un archivo CSV/Excel, elegí la clave y gestioná el stock.</p>
            </header>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" hidden />
            <div class="drop-zone" id="drop" role="button" tabindex="0" aria-describedby="dropHelp">
              <strong>Seleccioná o arrastrá inventario.csv / .xlsx</strong>
              <span id="dropHelp" class="hint">El archivo queda sólo en este dispositivo. Nada se sube a la nube.</span>
              <button class="button ghost" type="button">Buscar archivo</button>
            </div>
            <div class="button-row">
              <button class="button ghost" id="inventoryToggle" type="button" aria-controls="inventoryDrawer" aria-expanded="false">Administrar inventario</button>
              <button class="button primary" id="exportBtn" type="button">Descargar "conformado.csv"</button>
              <button class="button danger" id="clearBtn" type="button">Limpiar conformados</button>
            </div>
            <div class="status" id="inventoryStatus" aria-live="polite">Preparado para importar un inventario.</div>
          </article>
        </div>
        <div class="mobile-actions" role="group" aria-label="Acciones rápidas">
          <button class="button primary full" id="confirmBtnMobile" type="button" disabled>Conformar</button>
          <button class="button ghost full" id="exportBtnMobile" type="button">Descargar CSV</button>
        </div>
      </section>

      <main class="workspace" aria-label="Área de trabajo">
        <section class="video-shell" aria-label="Visor de cámara">
          <video id="video" playsinline muted></video>
          <div class="scan-overlay" aria-hidden="true">
            <div class="scan-top">
              <button class="button ghost" id="scanOnceBtn" type="button" disabled>Lectura única</button>
            </div>
            <div class="scan-bottom">
              <div class="pulse" id="pulse"></div>
              <span class="badge" id="scanLabel">Cámara inactiva</span>
            </div>
          </div>
        </section>

        <div class="data-panels">
          <article class="card details">
            <div class="card-header">
              <strong>Detalles del código</strong>
              <span id="matchChip" class="badge">—</span>
            </div>
            <div class="button-row">
              <div style="flex:1; min-width: min(260px, 100%); display: flex; flex-direction: column; gap: 8px;">
                <label for="detectedCode">Código detectado</label>
                <input id="detectedCode" type="text" readonly />
              </div>
              <div style="width:min(320px,100%); display:flex; flex-direction:column; gap:8px;">
                <label>Acción</label>
                <div class="button-row">
                  <button class="button primary" id="confirmBtn" type="button" disabled>Marcar como conformado</button>
                  <button class="button ghost" id="copyBtn" type="button" title="Copiar código" disabled>Copiar</button>
                </div>
              </div>
            </div>
            <div id="detailTableWrap" class="card" style="gap: var(--space-sm); background: rgba(7, 11, 22, 0.6);">
              <label>Información asociada</label>
              <p class="hint" id="noData">Cargá un inventario y elegí la columna clave para ver detalles.</p>
              <div id="detailTable" class="table-scroll hidden">
                <table id="detailTbl"></table>
              </div>
            </div>
          </article>

          <article class="card">
            <div class="card-header">
              <strong>Inventario (vista rápida)</strong>
              <span class="badge" id="visibleCount">0 visibles</span>
            </div>
            <div class="button-row">
              <div style="flex:1; min-width: min(220px, 100%); display:flex; flex-direction:column; gap:8px;">
                <label for="filterInput">Filtrar inventario</label>
                <input id="filterInput" type="text" placeholder="Buscar por cualquier columna" />
              </div>
              <div style="width:min(220px,100%); display:flex; flex-direction:column; gap:8px;">
                <label for="keySelect">Columna clave</label>
                <select id="keySelect"></select>
              </div>
            </div>
            <div class="table-scroll">
              <table id="invTbl"></table>
            </div>
          </article>

          <article class="card">
            <div class="card-header">
              <strong>Conformados</strong>
              <span class="badge" id="confCount">0</span>
            </div>
            <div class="table-scroll">
              <table id="confTbl"></table>
            </div>
          </article>

          <section class="card">
            <details>
              <summary>🧪 Pruebas rápidas – abrir para ejecutar</summary>
              <div class="button-row">
                <button class="button ghost" id="btnTestCSV" type="button">Test parser CSV</button>
                <button class="button ghost" id="btnTestExport" type="button">Test export CSV</button>
              </div>
              <p class="hint" id="autoLoadMsg">Los resultados se mostrarán en consola o como una descarga de ejemplo.</p>
            </details>
          </section>
        </div>
      </main>
    </div>

    <footer>
      <p><strong>Scan Control</strong> · Optimizado para operaciones móviles y depósitos desconectados.</p>
    </footer>
  </div>

  <aside id="inventoryDrawer" class="drawer hidden" aria-hidden="true" role="dialog" aria-label="Inventario cargado">
    <div class="drawer__panel">
      <header class="card-header">
        <div>
          <h2 style="margin:0; font-size: var(--font-lg);">Inventario cargado</h2>
          <p class="hint">Elegí la columna clave, filtrá y revisá los datos originales.</p>
        </div>
        <button class="button ghost" id="inventoryClose" type="button">Cerrar</button>
      </header>
      <label for="keySelectDrawer">Columna clave</label>
      <select id="keySelectDrawer"></select>
      <label for="filterInputDrawer">Filtro rápido</label>
      <input id="filterInputDrawer" type="text" placeholder="Buscar registros" />
      <div class="table-scroll" style="max-height: 50vh;">
        <table id="invTblDrawer"></table>
      </div>
    </div>
  </aside>

  <script src="./app.js"></script>
</body>
</html>
