<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini App Inventario · Escáner + CSV/XLSX</title>
    <style>
    :root{
      --bg: #020518;
      --bg-alt: #0c1124;
      --surface: rgba(14, 20, 40, 0.9);
      --surface-strong: rgba(16, 24, 46, 0.95);
      --border: rgba(142, 167, 255, 0.18);
      --brand: #6ef7d5;
      --accent: #8ea7ff;
      --text: #f5f7ff;
      --text-muted: #9fa9c6;
      --danger: #ff6b81;
      --warn: #f9b24e;
      --success: #38d996;
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 12px;
      --space-xs: 6px;
      --space-sm: clamp(8px, 1.8vw, 12px);
      --space: clamp(12px, 2.4vw, 20px);
      --space-lg: clamp(18px, 3vw, 26px);
      --space-xl: clamp(24px, 5vw, 34px);
      --font-xs: clamp(11px, 1.2vw, 12px);
      --font-sm: clamp(12px, 1.6vw, 13px);
      --font-md: clamp(14px, 1.9vw, 16px);
      --font-lg: clamp(18px, 3.2vw, 22px);
      --font-xl: clamp(22px, 5vw, 30px);
      --shadow-soft: 0 18px 45px rgba(8, 10, 25, 0.55);
      --shadow-raised: 0 12px 32px rgba(6, 10, 30, 0.45);
      --transition: 160ms ease;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #eef1ff;
        --bg-alt: #f7f8ff;
        --surface: rgba(255,255,255,0.92);
        --surface-strong: rgba(255,255,255,0.96);
        --border: rgba(71, 91, 168, 0.18);
        --text: #0d1538;
        --text-muted: #53608c;
      }
      body{
        color-scheme: light dark;
      }
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1600px 800px at -10% 0%, rgba(111,134,255,0.22), transparent 55%),
        radial-gradient(1300px 720px at 110% 5%, rgba(122,240,216,0.18), transparent 55%),
        var(--bg);
      line-height:1.55;
      -webkit-font-smoothing: antialiased;
    }
    body::before{
      content:'';
      position:fixed;
      inset:0;
      pointer-events:none;
      background: linear-gradient(120deg, rgba(255,255,255,0.06), transparent 45%),
                  radial-gradient(900px 600px at 50% -240px, rgba(132,159,255,0.22), transparent 65%);
      mix-blend-mode:soft-light;
      opacity:0.65;
    }
    a{color:inherit;}
    .app{
      position:relative;
      min-height:100dvh;
      max-width:1200px;
      margin:0 auto;
      padding: clamp(20px, 4vw, 48px) clamp(16px, 5vw, 60px) clamp(120px, 18vw, 140px);
      display:flex;
      flex-direction:column;
      gap:var(--space-lg);
    }
    @media (max-width:900px){
      .app{
        padding: clamp(16px, 4vw, 28px) clamp(14px, 5vw, 30px) calc(140px + env(safe-area-inset-bottom));
      }
    }
    .topbar,
    .panel{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow-soft);
      backdrop-filter:blur(26px);
      -webkit-backdrop-filter:blur(26px);
    }
    @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
      .topbar,
      .panel{
        background:var(--surface-strong);
      }
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space);
      padding:var(--space);
    }
    .topbar__brand{
      display:flex;
      align-items:center;
      gap:var(--space-sm);
      min-width:0;
    }
    .topbar svg{
      width:40px;
      height:40px;
      flex-shrink:0;
    }
    .topbar h1{
      margin:0;
      font-size:var(--font-xl);
      letter-spacing:-0.01em;
    }
    .subtitle{
      margin:0;
      font-size:var(--font-sm);
      color:var(--text-muted);
    }
    .stats{
      display:flex;
      align-items:center;
      gap:var(--space-sm);
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .app-grid{
      display:grid;
      gap:var(--space-lg);
    }
    @media (min-width:1080px){
      .app-grid{
        grid-template-columns: minmax(280px, 360px) minmax(0,1fr);
        align-items:start;
      }
      .workspace{
        padding-right:2px;
      }
    }
    .sidebar{
      display:flex;
      flex-direction:column;
      gap:var(--space-lg);
    }
    .workspace{
      display:flex;
      flex-direction:column;
      gap:var(--space-lg);
    }
    .section{
      display:flex;
      flex-direction:column;
      gap:var(--space);
    }
    .section.panel{
      padding:var(--space);
    }
    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-sm);
      flex-wrap:wrap;
    }
    .section-title h2{
      margin:0;
      font-size:var(--font-lg);
      font-weight:600;
    }
    .section-title p{
      margin:0;
      font-size:var(--font-sm);
      color:var(--text-muted);
    }
    input[type="file"]{display:none;}
    .file-drop{
      border:1.6px dashed rgba(255,255,255,0.22);
      border-radius:var(--radius-md);
      padding:calc(var(--space) + 4px);
      text-align:center;
      color:var(--text-muted);
      background:rgba(12,18,36,0.35);
      transition:border var(--transition), color var(--transition), background var(--transition), transform var(--transition);
    }
    .file-drop:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    .file-drop.drag{
      border-color:var(--brand);
      color:var(--brand);
      background:rgba(110,247,213,0.08);
      transform:translateY(-1px);
    }
    .field-grid{
      display:grid;
      gap:var(--space);
    }
    @media (min-width:640px){
      .field-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    label{
      font-size:var(--font-sm);
      font-weight:500;
      color:var(--text-muted);
    }
    select,
    input[type="text"],
    input[type="number"],
    textarea{
      width:100%;
      padding:12px 14px;
      font-size:var(--font-md);
      font-family:inherit;
      color:var(--text);
      background:rgba(9,14,32,0.8);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--radius-sm);
      transition:border var(--transition), box-shadow var(--transition), background var(--transition);
    }
    select:focus-visible,
    input:focus-visible,
    textarea:focus-visible{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(142,167,255,0.35);
      outline:none;
    }
    input::placeholder,
    textarea::placeholder{
      color:rgba(255,255,255,0.45);
    }
    input[readonly]{
      color:var(--text-muted);
    }
    .button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 16px;
      min-height:46px;
      font-size:var(--font-md);
      font-weight:600;
      border-radius:var(--radius-sm);
      border:1px solid rgba(255,255,255,0.08);
      background:linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      color:inherit;
      cursor:pointer;
      transition:transform var(--transition), box-shadow var(--transition), background var(--transition), border var(--transition);
      text-decoration:none;
    }
    .button:hover{
      transform:translateY(-1px);
      box-shadow:var(--shadow-raised);
    }
    .button:focus-visible{
      outline:2px solid var(--accent);
      outline-offset:2px;
    }
    .button:active{
      transform:translateY(0);
    }
    .button:disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    .button.primary{
      background:linear-gradient(180deg, rgba(110,247,213,0.32), rgba(110,247,213,0.12));
      border-color:rgba(110,247,213,0.48);
      color:#041a16;
    }
    .button.warn{
      background:linear-gradient(180deg, rgba(249,178,78,0.32), rgba(249,178,78,0.12));
      border-color:rgba(249,178,78,0.45);
      color:#2c1603;
    }
    .button.danger{
      background:linear-gradient(180deg, rgba(255,107,129,0.32), rgba(255,107,129,0.12));
      border-color:rgba(255,107,129,0.5);
      color:#2e030d;
    }
    .button.ghost{
      background:rgba(255,255,255,0.04);
    }
    .button.scan-trigger{
      background:rgba(8,12,30,0.72);
      border-color:rgba(255,255,255,0.14);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--space-sm);
      flex-wrap:wrap;
    }
    .row.fit{justify-content:flex-start;}
    .row.tight{gap:var(--space-sm);}
    .row.compact{gap:var(--space-xs);}
    .stack{
      display:flex;
      flex-direction:column;
      gap:var(--space-sm);
    }
    .code-field{flex:1; min-width:min(260px, 100%);}
    .action-block{width:min(340px,100%);}
    @media (max-width:720px){
      .action-block{width:100%;}
    }
    .kbd{
      font-family:'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace;
      background:rgba(12,18,40,0.72);
      border:1px solid rgba(255,255,255,0.09);
      border-radius:8px;
      padding:3px 8px;
      font-size:var(--font-xs);
    }
    .tip{
      font-size:var(--font-sm);
      color:var(--text-muted);
    }
    .tip strong{color:inherit;}
    .tip.status.success{color:var(--success);}
    .tip.status.error{color:var(--danger);}
    .tip.status.warn{color:var(--warn);}
    .pill,
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:999px;
      font-size:var(--font-sm);
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.06);
      color:inherit;
    }
    .chip.ok{
      border-color:rgba(56,217,150,0.5);
      background:rgba(56,217,150,0.18);
      color:#06291a;
    }
    .chip.bad{
      border-color:rgba(255,107,129,0.5);
      background:rgba(255,107,129,0.2);
      color:#2e0a11;
    }
    .video-wrap{
      position:relative;
      border-radius:var(--radius-lg);
      overflow:hidden;
      background:rgba(7,12,28,0.75);
      border:1px solid rgba(255,255,255,0.08);
      aspect-ratio:3 / 4;
      display:flex;
    }
    @media (min-width:720px){
      .video-wrap{aspect-ratio:16 / 9;}
    }
    video{
      width:100%;
      height:100%;
      object-fit:cover;
      filter:saturate(1.08) contrast(1.04);
    }
    .scan-action{
      position:absolute;
      top:14px;
      right:14px;
      display:flex;
      gap:10px;
    }
    .scan-status{
      position:absolute;
      left:16px;
      bottom:16px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pulse{
      width:12px;
      height:12px;
      border-radius:50%;
      background:var(--warn);
      box-shadow:0 0 0 0 rgba(249,178,78,0.45);
      animation:pulse 1.8s ease-in-out infinite;
    }
    .pulse.on{
      background:var(--brand);
      box-shadow:0 0 0 0 rgba(110,247,213,0.45);
    }
    @keyframes pulse{
      0%{transform:scale(0.9); box-shadow:0 0 0 0 rgba(255,255,255,0.28);}
      60%{transform:scale(1); box-shadow:0 0 0 14px rgba(255,255,255,0);}
      100%{box-shadow:0 0 0 0 rgba(255,255,255,0);}
    }
    .data-area{
      padding:var(--space);
      display:grid;
      gap:var(--space);
    }
    .result{
      display:grid;
      gap:var(--space);
    }
    @media (min-width:1024px){
      .result{
        grid-template-columns:1.05fr 0.95fr;
      }
    }
    .card{
      border-radius:var(--radius-lg);
      background:rgba(11,16,36,0.78);
      border:1px solid rgba(255,255,255,0.08);
      padding:var(--space);
      display:flex;
      flex-direction:column;
      gap:var(--space);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .table-scroll{
      overflow:auto;
      border-radius:calc(var(--radius-md) - 4px);
      border:1px solid rgba(255,255,255,0.05);
      background:rgba(4,8,20,0.65);
      max-height:42dvh;
    }
    .table-scroll table{
      width:100%;
      border-collapse:collapse;
      min-width:100%;
    }
    .table-scroll th,
    .table-scroll td{
      font-size:var(--font-sm);
      text-align:left;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      white-space:nowrap;
    }
    .table-scroll tr:hover{
      background:rgba(142,167,255,0.12);
    }
    .table-scroll::-webkit-scrollbar{
      height:8px;
      width:8px;
    }
    .table-scroll::-webkit-scrollbar-thumb{
      background:rgba(142,167,255,0.28);
      border-radius:999px;
    }
    .inventory-preview{
      max-height:28dvh;
    }
    .log{
      display:flex;
      flex-direction:column;
      gap:var(--space);
    }
    .log .table-scroll{
      max-height:50dvh;
    }
    .log tr.added{
      animation:glow .9s ease-out;
    }
    @keyframes glow{
      0%{background:rgba(110,247,213,0.24);}
      100%{background:transparent;}
    }
    .hidden{display:none!important;}
    .mobile-actions{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      z-index:30;
      padding:12px clamp(16px, 6vw, 40px) calc(12px + env(safe-area-inset-bottom));
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:center;
      background:linear-gradient(180deg, rgba(3,7,20,0), rgba(3,7,20,0.92) 35%, rgba(3,7,20,1) 90%);
      backdrop-filter:blur(22px);
      -webkit-backdrop-filter:blur(22px);
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .mobile-actions .button{flex:1;}
    @media (min-width:980px){
      .mobile-actions{display:none;}
    }
    footer{
      font-size:var(--font-sm);
      color:var(--text-muted);
      text-align:center;
      padding-bottom:env(safe-area-inset-bottom);
    }
    footer strong{color:var(--text);}
    details{
      border-radius:var(--radius-md);
      background:rgba(12,18,38,0.6);
      border:1px solid rgba(255,255,255,0.08);
      padding:var(--space);
    }
    details summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      gap:var(--space-sm);
      font-weight:600;
      font-size:var(--font-md);
    }
    details summary::-webkit-details-marker{display:none;}
    details[open]{background:rgba(12,18,38,0.72);}
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important; transition:none!important;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="topbar panel">
      <div class="topbar__brand">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 2l2.3 4.7L19 7.3l-3.5 3.4.8 4.9L12 13.8l-4.3 1.8.8-4.9L5 7.3l4.7-.6L12 2z" stroke="url(#g1)" stroke-width="1.3"/>
          <defs><linearGradient id="g1" x1="0" y1="0" x2="24" y2="24"><stop stop-color="#7cf2d3"/><stop offset="1" stop-color="#9aa8ff"/></linearGradient></defs>
        </svg>
        <div class="stack">
          <h1>Mini App Inventario</h1>
          <p class="subtitle">Escáner portátil para control de stock y depósitos móviles.</p>
        </div>
      </div>
      <div class="stats">
        <span class="pill" id="invCount" aria-live="polite">0 ítems</span>
      </div>
    </header>

    <div class="app-grid">
      <aside class="sidebar" aria-label="Panel de control">
        <section class="panel section stack" aria-label="Carga de inventario">
          <div class="section-title">
            <div class="stack">
              <h2>Inventario</h2>
              <p>Importá tu archivo CSV o Excel para habilitar coincidencias instantáneas.</p>
            </div>
            <label class="button ghost" for="fileInput">Seleccionar</label>
          </div>
          <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" />
          <div id="drop" class="file-drop" tabindex="0">Arrastrá y soltá el archivo aquí</div>
          <div class="field-grid">
            <div class="stack">
              <label for="keySelect">Columna clave</label>
              <select id="keySelect"></select>
            </div>
            <div class="stack">
              <label for="filterInput">Filtro rápido</label>
              <input id="filterInput" type="text" placeholder="Buscar en inventario" />
            </div>
          </div>
          <div class="tip status" id="autoLoadMsg" aria-live="polite"></div>
          <div class="tip">Sugerencia: para uso 100% offline, preferí CSV (el soporte Excel usa un script CDN).</div>
        </section>

        <section class="panel section stack" aria-label="Escáner de códigos">
          <div class="section-title">
            <div class="stack">
              <h2>Escáner</h2>
              <p>Activá la cámara o ingresá códigos manualmente.</p>
            </div>
            <span class="chip" id="apiStatus">API: detectando…</span>
          </div>
          <div class="row fit tight">
            <button class="button primary" id="startBtn" type="button">Iniciar cámara</button>
            <button class="button warn" id="stopBtn" type="button" disabled>Detener</button>
            <button class="button" id="flashBtn" type="button" disabled>Flash</button>
            <button class="button" id="switchBtn" type="button" disabled>Cambiar</button>
          </div>
          <div class="stack">
            <label for="manualInput">Ingreso manual</label>
            <div class="row fit tight">
              <input id="manualInput" type="text" placeholder="Pegá o escribí un código y Enter" />
              <button class="button" id="manualBtn" type="button">OK</button>
            </div>
            <div class="tip">Atajo: <span class="kbd">Enter</span> confirma. <span class="kbd">Ctrl/Cmd + C</span> conforma.</div>
          </div>
          <div class="mobile-actions" role="group" aria-label="Acciones rápidas">
            <button class="button primary" id="confirmBtnMobile" type="button" disabled>Conformar</button>
            <button class="button" id="exportBtnMobile" type="button">Descargar CSV</button>
          </div>
        </section>

        <section class="panel section stack" aria-label="Acciones">
          <div class="row tight">
            <button class="button primary" id="exportBtn" type="button">Descargar "conformado.csv"</button>
            <button class="button danger" id="clearBtn" type="button">Limpiar conformados</button>
          </div>
        </section>
      </aside>

      <main class="workspace">
        <div class="panel video-wrap" aria-label="Visor de la cámara">
          <video id="video" playsinline muted></video>
          <div class="scan-action">
            <button class="button scan-trigger" id="scanOnceBtn" type="button" disabled>Ejecutar lectura</button>
          </div>
          <div class="scan-status">
            <div id="pulse" class="pulse" aria-hidden="true"></div>
            <span id="scanLabel" class="pill">Cámara inactiva</span>
          </div>
        </div>

        <div class="panel data-area">
          <div class="result">
            <div class="card details">
              <div class="row tight">
                <strong>Detalles del código</strong>
                <span id="matchChip" class="chip" aria-live="polite">—</span>
              </div>
              <div class="stack">
                <div class="row fit tight">
                  <div class="stack code-field">
                    <label for="detectedCode">Código detectado</label>
                    <input id="detectedCode" type="text" readonly />
                  </div>
                  <div class="stack action-block">
                    <label>Acción</label>
                    <div class="row fit compact">
                      <button class="button primary" id="confirmBtn" type="button" disabled>Marcar como conformado</button>
                      <button class="button ghost" id="copyBtn" type="button" title="Copiar código" disabled>Copiar</button>
                    </div>
                  </div>
                </div>
                <div id="detailTableWrap" class="stack">
                  <label>Información asociada</label>
                  <div class="tip" id="noData">Cargá un inventario y elegí la columna clave para ver detalles.</div>
                  <div id="detailTable" class="table-scroll hidden">
                    <table id="detailTbl"></table>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="row tight">
                <strong>Inventario (vista rápida)</strong>
                <span class="pill" id="visibleCount">0 visibles</span>
              </div>
              <div class="table-scroll inventory-preview">
                <table id="invTbl"></table>
              </div>
            </div>
          </div>
          <div class="card log">
            <div class="row tight">
              <strong>Conformados</strong>
              <span class="pill" id="confCount">0</span>
            </div>
            <div class="table-scroll">
              <table id="confTbl"></table>
            </div>
          </div>
        </div>

        <section class="panel section stack">
          <details>
            <summary>🧪 Pruebas rápidas (CSV/Export) – abrir para ejecutar</summary>
            <div class="stack">
              <button class="button" id="btnTestCSV" type="button">Test parser CSV</button>
              <button class="button" id="btnTestExport" type="button">Test export CSV</button>
              <div class="tip">Los resultados se muestran en la consola del navegador y/o como descarga de un archivo de prueba.</div>
            </div>
          </details>
        </section>
      </main>
    </div>

    <footer>Hecho con ❤️ para flujos rápidos en depósito y control.</footer>
  </div>
  <!-- Script principal -->
  <script>
  const state = {
    inventory: [],
    columns: [],
    key: null,
    index: new Map(),
    conformados: [],
    cameraDevices: [],
    currentDeviceId: null,
    scanning: false,
    detector: null,
    fallbackReader: null,
    fallbackErrorShown: false,
    torchOn: false,
    lastScan: { code: null, time: 0 },
    inventoryName: null,
    exportDelimiter: ';',
  };

  const BARCODE_FORMATS = ['code_128','ean_13','ean_8','upc_a','upc_e','code_39','code_93','itf','codabar','qr_code','data_matrix','pdf417'];

  // ---- Utilidades UI ----
  const $ = sel => document.querySelector(sel);
  const el = (tag, attrs={},{children=[]}={}) => { const n = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==="class") n.className=v; else if(k==="text") n.textContent=v; else n.setAttribute(k,v)}); children.forEach(c=> n.appendChild(c)); return n};
  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  // Evita el warning de ZXing "Trying to play video that is already playing"
  // devolviendo un resolved Promise cuando el video ya está en reproducción.
  if(typeof HTMLMediaElement !== 'undefined' && !HTMLMediaElement.prototype.play.__scanGuarded){
    const originalPlay = HTMLMediaElement.prototype.play;
    const guardedPlay = function(...args){
      if(this && typeof this.paused === 'boolean' && !this.paused){
        return typeof Promise !== 'undefined' ? Promise.resolve() : undefined;
      }
      return originalPlay.apply(this, args);
    };
    guardedPlay.__scanGuarded = true;
    HTMLMediaElement.prototype.play = guardedPlay;
  }

  let scanLabelTimer = null;
  let manualScanBusy = false;

  function setChip(id, text, ok=null){
    const chip = $(id); chip.textContent = text;
    chip.classList.remove('ok','bad');
    if(ok===true) chip.classList.add('ok');
    if(ok===false) chip.classList.add('bad');
  }

  function setScanLabel(text, revertMs=null){
    const label = $('#scanLabel');
    if(!label) return;
    label.textContent = text;
    if(scanLabelTimer){ clearTimeout(scanLabelTimer); scanLabelTimer = null; }
    if(revertMs!==null){
      scanLabelTimer = setTimeout(()=>{
        scanLabelTimer = null;
        if(state.scanning){ label.textContent = 'Escaneando…'; }
      }, revertMs);
    }
  }

  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    const c = el('canvas',{style:`position:fixed;left:0;top:0;width:100vw;height:100vh;pointer-events:none;z-index:9999`});
    document.body.appendChild(c);
    const ctx = c.getContext('2d'); c.width=innerWidth; c.height=innerHeight;
    const parts = Array.from({length:120},()=>({x,y,vx:(Math.random()-0.5)*6,vy:(Math.random()*-6-3),w:2+Math.random()*3,h:6+Math.random()*6,rot:Math.random()*Math.PI,vr:(Math.random()-0.5)*.2,life:120+Math.random()*60, col:`hsl(${Math.random()*360},90%,70%)`}));
    let tick=0; (function loop(){ ctx.clearRect(0,0,c.width,c.height); parts.forEach(p=>{ p.vy+=.12; p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.life--; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle=p.col; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore(); });
      if(++tick<180){ requestAnimationFrame(loop)} else c.remove(); })();
  }

  // ---- CSV Parser (ligero, con autodetección de separador) ----
  function stripBom(text){ return text.replace(/^\uFEFF/, ''); }

  function detectDelimiter(text){
    const sample = stripBom(text).split(/\r?\n/).find(line=> line.trim().length) || '';
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = 0;
    for(const delimiter of candidates){
      let count = 0; let inQ = false;
      for(let i=0;i<sample.length;i++){
        const ch = sample[i];
        if(ch==='"'){
          if(inQ && sample[i+1]==='"'){ i++; }
          inQ = !inQ;
        } else if(ch===delimiter && !inQ){ count++; }
      }
      if(count>bestCount){ best = delimiter; bestCount = count; }
    }
    return bestCount>0 ? best : ',';
  }

  function parseCSV(text, delimiter=','){
    const clean = stripBom(text);
    const rows = [];
    let cur = '', row = [], inQ=false;
    for(let i=0;i<clean.length;i++){
      const ch = clean[i], next = clean[i+1];
      if(ch==='"'){
        if(inQ && next==='"'){ cur+='"'; i++; }
        else { inQ = !inQ; }
      } else if(ch===delimiter && !inQ){
        row.push(cur); cur='';
      } else if((ch==='\n' || ch==='\r') && !inQ){
        if(ch==='\r' && next==='\n'){ i++; }
        if(cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
      } else {
        cur+=ch;
      }
    }
    if(cur!=='' || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  function parseCSVAuto(text){
    const delimiter = detectDelimiter(text);
    const rows = parseCSV(text, delimiter).filter(r=> r.length && r.some(c=> String(c ?? '').trim()!==''));
    return { rows, delimiter };
  }

  // ---- Lectura de archivos ----
  async function loadFile(file){
    if(!file) return;
    try{
      const name = file.name;
      const lower = name.toLowerCase();
      if(lower.endsWith('.csv')){
        const text = await file.text();
        const {rows, delimiter} = parseCSVAuto(text);
        hydrateInventory(rows, { name, delimiter });
      } else if(lower.endsWith('.xlsx') || lower.endsWith('.xls')){
        await ensureSheetJS();
        if(!window.XLSX){
          alert('No se pudo cargar el lector de Excel. Exportá a CSV y volvé a intentar.');
          setInventoryStatus('No se pudo cargar el lector de Excel. Preferí CSV para uso offline.', 'warn');
          return;
        }
        const buf = await file.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1, defval:''});
        hydrateInventory(rows, { name });
      } else {
        alert('Formato no soportado. Usá CSV o Excel (.xlsx).');
        setInventoryStatus('Formato no soportado. Seleccioná un CSV o Excel.', 'error');
      }
    }catch(err){
      console.error('Error al leer archivo', err);
      alert('Ocurrió un problema al leer el archivo seleccionado. Verificá el formato e intentá nuevamente.');
      setInventoryStatus('No se pudo cargar el archivo seleccionado.', 'error');
    }
  }

  function uniqueColumnNames(rawHeader){
    const seen = new Set();
    return rawHeader.map((name, idx)=>{
      let base = String(name ?? '').replace(/\uFEFF/g,'').trim();
      if(!base){ base = `col_${idx+1}`; }
      let final = base;
      let counter = 2;
      while(seen.has(final)){
        final = `${base}_${counter++}`;
      }
      seen.add(final);
      return final;
    });
  }

  function normalizeRowValue(value){
    if(value===null || value===undefined) return '';
    if(typeof value === 'string') return value.replace(/\uFEFF/g,'').trim();
    return String(value);
  }

  function setInventoryStatus(text='', tone='info'){
    const msg = $('#autoLoadMsg');
    if(!msg) return;
    msg.textContent = text;
    msg.classList.remove('success','error','warn');
    if(tone==='success') msg.classList.add('success');
    else if(tone==='error') msg.classList.add('error');
    else if(tone==='warn') msg.classList.add('warn');
  }

  function hydrateInventory(rows, {name='inventario', delimiter}={}){
    if(!rows.length){
      alert('El archivo está vacío.');
      setInventoryStatus('El archivo no contiene registros.', 'error');
      return;
    }
    const [header, ...data] = rows;
    state.columns = uniqueColumnNames(header);
    state.inventory = data
      .filter(r=> Array.isArray(r) && r.some(c=> String(c ?? '').trim()!==''))
      .map(r=> Object.fromEntries(state.columns.map((c,i)=>[c, normalizeRowValue(r[i])] )));
    if(!state.columns.length){
      setInventoryStatus('No se detectaron columnas en el archivo.', 'error');
      return;
    }
    state.inventoryName = name;
    if(delimiter){ state.exportDelimiter = delimiter; }
    $('#filterInput').value = '';
    // Detectar columna probable de código
    const lc = state.columns.map(c=>c.toLowerCase());
    const guess = ['codigo','código','barcode','barra','ean','sku','id','inventario','cod_barra','code','nro.inventario']
      .find(k=> lc.includes(k));
    state.key = guess || state.columns[0];
    rebuildIndex();
    paintInventory();
    fillKeySelect();
    paintConformados();
    $('#invCount').textContent = `${state.inventory.length} ítems`;
    setInventoryStatus(`Inventario cargado${name?` (${name})`:''}: ${state.inventory.length} ítems disponibles.`, 'success');
  }

  function rebuildIndex(){
    state.index = new Map();
    if(!state.columns.includes(state.key)){
      state.key = state.columns[0] || null;
    }
    if(!state.key) return;
    for(const row of state.inventory){
      const code = String(row[state.key] ?? '').trim();
      if(code) state.index.set(code, row);
    }
  }

  function fillKeySelect(){
    const sel = $('#keySelect'); sel.innerHTML = '';
    state.columns.forEach(c=> sel.appendChild(el('option',{value:c, text:c})));
    sel.disabled = state.columns.length===0;
    sel.value = state.key || '';
  }

  function paintInventory(){
    const tbl = $('#invTbl'); tbl.innerHTML = '';
    if(!state.columns.length){
      const tr = el('tr');
      const td = el('td',{text:'Cargá un inventario para ver la vista previa.'});
      td.colSpan = 1;
      tr.appendChild(td);
      tbl.appendChild(tr);
      $('#visibleCount').textContent = '0 visibles';
      return;
    }
    const head = el('tr');
    const cols = state.columns.slice(0, 6);
    cols.forEach(c=> head.appendChild(el('th',{text:c})));
    tbl.appendChild(head);
    const filter = $('#filterInput').value.toLowerCase();
    let visible = 0;
    for(const row of state.inventory){
      const line = cols.map(c=> String(row[c]??'')).join(' ').toLowerCase();
      if(filter && !line.includes(filter)) continue;
      visible++;
      const tr = el('tr');
      cols.forEach(c=> tr.appendChild(el('td',{text:String(row[c]??'')})));
      tbl.appendChild(tr);
    }
    $('#visibleCount').textContent = `${visible} visibles`;
  }

  // ---- Cámara y BarcodeDetector ----
  async function initDevices(){
    try{
      const devs = await navigator.mediaDevices.enumerateDevices();
      state.cameraDevices = devs.filter(d=> d.kind==='videoinput');
      $('#switchBtn').disabled = state.cameraDevices.length<2;
    }catch(e){ console.warn(e); }
  }

  async function startCamera(){
    try{
      const videoConstraints = { width:{ideal:1280}, height:{ideal:720}, facingMode:'environment' };
      if(state.currentDeviceId){
        delete videoConstraints.facingMode;
        videoConstraints.deviceId = { exact: state.currentDeviceId };
      }
      const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints });
      const v = $('#video'); v.srcObject = stream; await v.play();
      const track = stream.getVideoTracks?.()[0];
      state.currentDeviceId = track?.getSettings?.().deviceId || state.currentDeviceId;
      $('#pulse').classList.add('on');
      setScanLabel('Escaneando…');
      $('#startBtn').disabled = true; $('#stopBtn').disabled = false;
      $('#flashBtn').textContent = 'Flash';
      state.torchOn = false;
      let torchAvailable = !!track;
      const caps = track?.getCapabilities?.();
      if(track && caps && ('torch' in caps)){
        torchAvailable = !!caps.torch;
      }
      $('#flashBtn').disabled = !torchAvailable;
      state.scanning = true;
      manualScanBusy = false;
      const scanBtn = $('#scanOnceBtn');
      if(scanBtn){
        scanBtn.disabled = false;
        scanBtn.textContent = 'Ejecutar lectura';
      }
      state.detector = null;
      if(state.fallbackReader?.reset) state.fallbackReader.reset();
      state.fallbackReader = null;
      state.fallbackErrorShown = false;
      _lastDetectTs = 0;
      if(!('BarcodeDetector' in window)){
        const ZX = await ensureZXing();
        if(ZX && ZX.BrowserMultiFormatReader){
          state.fallbackReader = new ZX.BrowserMultiFormatReader();
          if('timeBetweenDecodingAttempts' in state.fallbackReader){
            state.fallbackReader.timeBetweenDecodingAttempts = DETECT_EVERY_MS;
          }
          if('timeBetweenScansMillis' in state.fallbackReader){
            state.fallbackReader.timeBetweenScansMillis = DETECT_EVERY_MS;
          }
          setChip('#apiStatus','API: ZXing (fallback)', true);
        } else {
          setChip('#apiStatus','API: no disponible (sin ZXing)', false);
          if(!state.fallbackErrorShown){
            alert('Este navegador no soporta BarcodeDetector y no se pudo cargar la librería ZXing. Usá el ingreso manual.');
            state.fallbackErrorShown = true;
          }
          stopCamera();
          return;
        }
      }
      await initDevices();
      detectLoop();
    }catch(e){ alert('No se pudo acceder a la cámara. Revisá permisos.'); console.error(e); }
  }

  function stopCamera(){
    const v = $('#video');
    const s = v.srcObject;
    if(s){ s.getTracks().forEach(t=>t.stop()); v.srcObject=null; }
    state.scanning = false;
    manualScanBusy = false;
    $('#pulse').classList.remove('on');
    setScanLabel('Cámara inactiva');
    $('#startBtn').disabled = false; $('#stopBtn').disabled = true;
    $('#flashBtn').disabled = true; $('#flashBtn').textContent = 'Flash';
    state.torchOn = false;
    const scanBtn = $('#scanOnceBtn');
    if(scanBtn){
      scanBtn.disabled = true;
      scanBtn.textContent = 'Ejecutar lectura';
    }
    state.detector = null;
    if(state.fallbackReader?.reset) state.fallbackReader.reset();
    state.fallbackReader = null;
  }

  async function toggleTorch(){
    const track = $('#video').srcObject?.getVideoTracks?.()[0];
    if(!track) return;
    const caps = track.getCapabilities?.()||{}; if(!caps.torch){ return alert('El flash no está disponible en este dispositivo.'); }
    state.torchOn = !state.torchOn;
    await track.applyConstraints({ advanced: [{ torch: state.torchOn }] });
    $('#flashBtn').textContent = state.torchOn? 'Flash (ON)' : 'Flash';
  }

  async function switchCamera(){
    if(state.cameraDevices.length<2) return;
    const idx = state.cameraDevices.findIndex(d=> d.deviceId===state.currentDeviceId);
    const next = state.cameraDevices[(idx+1) % state.cameraDevices.length];
    state.currentDeviceId = next.deviceId; stopCamera(); startCamera();
  }

  // Throttle de detección para mejorar rendimiento en móvil
  let _lastDetectTs = 0;
  const DETECT_EVERY_MS = 250;
  const ZXING_MANUAL_TIMEOUT_MS = 1500;

  async function detectLoop(){
    if(!state.scanning) return;
    try{
      const video = $('#video');
      const now = performance.now();

      if(state.detector){
        if((now - _lastDetectTs) > DETECT_EVERY_MS && video.readyState >= 2){
          _lastDetectTs = now;
          try{
            const bitmap = await createImageBitmap(video);
            const codes = await state.detector.detect(bitmap);
            bitmap.close?.();
            if(codes && codes.length && state.scanning){
              const first = codes[0];
              onDetect(first.rawValue || first.displayValue);
            }
          }catch(err){
            console.warn('Error detectando con BarcodeDetector', err);
          }
        }
      } else if('BarcodeDetector' in window && !state.fallbackReader){
        try{
          state.detector = new BarcodeDetector({formats: BARCODE_FORMATS});
          setChip('#apiStatus','API: BarcodeDetector', true);
          _lastDetectTs = 0;
        }catch(err){
          console.warn('BarcodeDetector no disponible, usando ZXing', err);
          state.detector = null;
        }
      }

      if(!state.detector){
        if(!state.fallbackReader){
          const ZX = await ensureZXing();
          if(ZX && ZX.BrowserMultiFormatReader){
            state.fallbackReader = new ZX.BrowserMultiFormatReader();
            if('timeBetweenDecodingAttempts' in state.fallbackReader){
              state.fallbackReader.timeBetweenDecodingAttempts = DETECT_EVERY_MS;
            }
            if('timeBetweenScansMillis' in state.fallbackReader){
              state.fallbackReader.timeBetweenScansMillis = DETECT_EVERY_MS;
            }
            setChip('#apiStatus','API: ZXing (fallback)', true);
            state.fallbackErrorShown = false;
            _lastDetectTs = 0;
          } else {
            setChip('#apiStatus','API: no disponible (sin ZXing)', false);
            if(!state.fallbackErrorShown){
              alert('Este navegador no soporta BarcodeDetector y no se pudo cargar la librería ZXing. Usá el ingreso manual.');
              state.fallbackErrorShown = true;
            }
            stopCamera();
            return;
          }
        }
        if(state.fallbackReader && (now - _lastDetectTs) > DETECT_EVERY_MS && video.readyState >= 2){
          _lastDetectTs = now;
          try{
            const result = await state.fallbackReader.decodeFromVideoElement(video);
            const text = result?.text || result?.getText?.();
            if(text && state.scanning){ onDetect(text); }
          }catch(err){
            const ZX = window.ZXing;
            const name = err?.name;
            if(ZX && (err instanceof ZX.NotFoundException || err instanceof ZX.ChecksumException || err instanceof ZX.FormatException)){
              // Errores esperados cuando no hay código en el frame
            } else if(name && ['NotFoundException','ChecksumException','FormatException'].includes(name)){
              // Errores esperados sin ZXing global disponible
            } else if(err?.message?.includes('No MultiFormat Readers were able to detect')){
              // ZXing no encontró código en este frame
            } else {
              console.warn('Error detectando con ZXing', err);
            }
          }
        }
      }
    }catch(err){
      console.warn('detectLoop error', err);
    }
    requestAnimationFrame(detectLoop);
  }

  async function scanOnce(){
    if(manualScanBusy) return;
    if(!state.scanning){
      alert('Iniciá la cámara para ejecutar una lectura.');
      return;
    }
    const video = $('#video');
    const btn = $('#scanOnceBtn');
    if(!video?.srcObject){
      alert('No hay una cámara activa. Iniciá la cámara.');
      return;
    }
    manualScanBusy = true;
    const prevText = btn?.textContent || '';
    if(btn){
      btn.disabled = true;
      btn.textContent = 'Leyendo…';
    }
    setScanLabel('Buscando código…');
    let detected = false;
    try{
      if(video.readyState < 2){
        await sleep(120);
      }
      if('BarcodeDetector' in window && !state.fallbackReader){
        if(!state.detector){
          try{
            state.detector = new BarcodeDetector({formats: BARCODE_FORMATS});
            setChip('#apiStatus','API: BarcodeDetector', true);
            _lastDetectTs = 0;
          }catch(err){
            console.warn('BarcodeDetector no disponible, usando ZXing', err);
            state.detector = null;
          }
        }
        if(state.detector){
          let bitmap;
          try{
            bitmap = await createImageBitmap(video);
            const codes = await state.detector.detect(bitmap);
            const first = codes?.[0];
            const value = first?.rawValue || first?.displayValue || '';
            if(value){
              detected = true;
              onDetect(value);
            }
          }finally{
            bitmap?.close?.();
          }
        }
      }
      if(!detected){
        if(!state.fallbackReader){
          const ZX = await ensureZXing();
          if(ZX && ZX.BrowserMultiFormatReader){
            state.fallbackReader = new ZX.BrowserMultiFormatReader();
            if('timeBetweenDecodingAttempts' in state.fallbackReader){
              state.fallbackReader.timeBetweenDecodingAttempts = DETECT_EVERY_MS;
            }
            if('timeBetweenScansMillis' in state.fallbackReader){
              state.fallbackReader.timeBetweenScansMillis = DETECT_EVERY_MS;
            }
            if(!('BarcodeDetector' in window) || !state.detector){
              setChip('#apiStatus','API: ZXing (fallback)', true);
            }
            state.fallbackErrorShown = false;
          } else {
            setChip('#apiStatus','API: no disponible (sin ZXing)', false);
            if(!state.fallbackErrorShown){
              alert('Este navegador no soporta BarcodeDetector y no se pudo cargar la librería ZXing. Usá el ingreso manual.');
              state.fallbackErrorShown = true;
            }
          }
        }
        if(state.fallbackReader){
          const ZX = window.ZXing;
          try{
            const result = await Promise.race([
              state.fallbackReader.decodeFromVideoElement(video),
              new Promise((_, reject)=> setTimeout(()=> reject(new Error('ZXING_TIMEOUT')), ZXING_MANUAL_TIMEOUT_MS))
            ]);
            const text = result?.text || result?.getText?.();
            if(text){
              detected = true;
              onDetect(text);
            }
          }catch(err){
            if(err?.message === 'ZXING_TIMEOUT'){
              // Sin código detectado dentro del tiempo límite
            } else {
              const name = err?.name;
              if(ZX && (err instanceof ZX.NotFoundException || err instanceof ZX.ChecksumException || err instanceof ZX.FormatException)){
                // Errores esperados cuando no hay código en el frame
              } else if(name && ['NotFoundException','ChecksumException','FormatException'].includes(name)){
                // Errores esperados sin ZXing global disponible
              } else if(err?.message?.includes('No MultiFormat Readers were able to detect')){
                // ZXing no encontró código en este frame
              } else {
                console.warn('Error detectando con ZXing (manual)', err);
              }
            }
          }finally{
            try{ state.fallbackReader.reset?.(); }catch{}
          }
        }
      }
      if(detected){
        setScanLabel('Código detectado', 1800);
      } else {
        setScanLabel('Sin resultados', 1800);
      }
    }catch(err){
      console.warn('scanOnce error', err);
      setScanLabel('Error en lectura', 2000);
    }finally{
      if(state.scanning){
        _lastDetectTs = performance.now();
      }
      if(btn){
        btn.textContent = prevText || 'Ejecutar lectura';
        if(state.scanning){
          btn.disabled = false;
        }
      }
      manualScanBusy = false;
    }
  }

  function onDetect(code){
    code = String(code||'').trim(); if(!code) return;
    // Anti-rebote: evita repetir el mismo código por 3s
    const now = Date.now();
    if(state.lastScan.code===code && (now - state.lastScan.time) < 3000) return;
    state.lastScan = { code, time: now };

    $('#detectedCode').value = code; $('#copyBtn').disabled = false; $('#confirmBtn').disabled = false; $('#confirmBtnMobile').disabled = false;
    const row = state.index.get(code);
    if(row){
      setChip('#matchChip','Coincide en inventario', true);
      paintDetails(row);
      flashOK();
    } else {
      setChip('#matchChip','No encontrado en inventario', false);
      clearDetails();
      flashWarn();
    }
  }

  function paintDetails(row){
    $('#noData').classList.add('hidden'); $('#detailTable').classList.remove('hidden');
    const tbl = $('#detailTbl'); tbl.innerHTML='';
    for(const c of state.columns){
      const tr = el('tr'); tr.appendChild(el('th',{text:c})); tr.appendChild(el('td',{text:String(row[c]??'')})); tbl.appendChild(tr);
    }
  }
  function clearDetails(){ $('#detailTbl').innerHTML=''; $('#detailTable').classList.add('hidden'); $('#noData').classList.remove('hidden'); }

  function flashOK(){
    const card = document.querySelector('.details'); card.style.boxShadow='0 0 0 2px rgba(56,217,150,.5)'; setTimeout(()=> card.style.boxShadow='', 320);
  }
  function flashWarn(){
    const card = document.querySelector('.details'); card.style.boxShadow='0 0 0 2px rgba(255,191,105,.6)'; setTimeout(()=> card.style.boxShadow='', 320);
  }

  function addConformado(code){
    const ts = new Date().toISOString();
    const row = state.index.get(String(code)) || null;
    // Evitar duplicados exactos por código
    if(state.conformados.some(x=> x.codigo===code)) return;
    const rec = { codigo: code, timestamp: ts };
    if(row){ for(const c of state.columns){ rec[c] = row[c]??''; } rec._match = '1'; }
    else { rec._match = '0'; }
    state.conformados.unshift(rec);
    persistConformados();
    paintConformados();
    confetti(window.innerWidth-180, 140);
  }

  function paintConformados(){
    const tbl = $('#confTbl'); tbl.innerHTML='';
    const cols = ['timestamp','codigo','_match', ...state.columns.slice(0,4)];
    const head = el('tr'); cols.forEach(c=> head.appendChild(el('th',{text:c}))); tbl.appendChild(head);
    for(const rec of state.conformados){
      const tr = el('tr'); tr.classList.add('added');
      cols.forEach(c=> tr.appendChild(el('td',{text:String(rec[c]??'')})));
      tbl.appendChild(tr);
    }
    $('#confCount').textContent = state.conformados.length;
  }

  function exportCSV(){
    if(!state.conformados.length){ alert('No hay registros para exportar.'); return; }
    const cols = Array.from(new Set(['timestamp','codigo','_match', ...state.columns]));
    const esc=v=> '"'+String(v??'').replace(/"/g,'""')+'"';
    const delim = state.exportDelimiter || ',';
    const lines = [cols.map(esc).join(delim)];
    state.conformados.forEach(rec=>{ lines.push(cols.map(c=> esc(rec[c])).join(delim)); });
    const blob = new Blob(['\uFEFF'+lines.join('\r\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = el('a',{href:url, download:'conformado.csv'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function persistConformados(){
    try{ localStorage.setItem('conformados_v1', JSON.stringify(state.conformados)); }catch{}
  }
  function restoreConformados(){
    try{ const v = JSON.parse(localStorage.getItem('conformados_v1')||'[]'); if(Array.isArray(v)) state.conformados = v; }catch{}
    paintConformados();
  }

  async function ensureSheetJS(){
    if(window.XLSX) return;
    await new Promise((resolve)=>{
      const s = document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'; s.onload=resolve; s.onerror=resolve; document.head.appendChild(s);
    });
  }

  let ensureZXingPromise = null;
  async function ensureZXing(){
    if(window.ZXing && window.ZXing.BrowserMultiFormatReader) return window.ZXing;
    if(ensureZXingPromise) return ensureZXingPromise;
    ensureZXingPromise = new Promise((resolve)=>{
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js';
      s.onload = ()=> resolve(window.ZXing || null);
      s.onerror = ()=> resolve(null);
      document.head.appendChild(s);
    });
    const lib = await ensureZXingPromise;
    if(!lib || !lib.BrowserMultiFormatReader){
      ensureZXingPromise = null;
      return null;
    }
    return lib;
  }

  // ---- Eventos ----
  async function loadDefaultInventory(){
    try{
      const res = await fetch('inventario.csv', {cache:'no-store'});
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      if(!text.trim()) throw new Error('Archivo vacío');
      const {rows, delimiter} = parseCSVAuto(text);
      hydrateInventory(rows, { name: 'inventario.csv', delimiter });
    }catch(err){
      console.info('Inventario automático no disponible:', err);
      const manualMsg = location.protocol === 'file:'
        ? 'Abrí este archivo desde un servidor o seleccioná el inventario manualmente.'
        : 'Seleccioná un archivo usando el botón "Seleccionar" o arrastralo al recuadro.';
      setInventoryStatus(manualMsg, 'warn');
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    restoreConformados();
    await initDevices();
    setInventoryStatus('Buscando inventario predeterminado…', 'info');
    loadDefaultInventory();
    $('#keySelect').addEventListener('change', e=>{ state.key = e.target.value; rebuildIndex(); });
    $('#filterInput').addEventListener('input', paintInventory);

    // Drag & drop
    const drop = $('#drop');
    const handleLoad = e=>{ e.preventDefault(); drop.classList.remove('drag'); const f = (e.dataTransfer||{}).files?.[0]; if(f) loadFile(f); };
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
    drop.addEventListener('drop', handleLoad);

    // También click / Enter sobre el área de drop
    drop.addEventListener('click', ()=> $('#fileInput').click());
    drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); $('#fileInput').click(); } });

    // File input
    $('#fileInput').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) loadFile(f); e.target.value=''; });

    // Scanner
    $('#startBtn').addEventListener('click', startCamera);
    $('#stopBtn').addEventListener('click', stopCamera);
    $('#flashBtn').addEventListener('click', toggleTorch);
    $('#switchBtn').addEventListener('click', switchCamera);
    $('#scanOnceBtn').addEventListener('click', scanOnce);

    // Manual input
    const manual = ()=>{ const v = $('#manualInput').value.trim(); if(!v) return; onDetect(v); $('#manualInput').value=''; };
    $('#manualBtn').addEventListener('click', manual);
    $('#manualInput').addEventListener('keydown', e=>{ if(e.key==='Enter') manual(); });

    // Actions
    const confirmAction = ()=>{ const code = $('#detectedCode').value; if(!code) return; addConformado(code); };
    $('#confirmBtn').addEventListener('click', confirmAction);
    $('#confirmBtnMobile').addEventListener('click', confirmAction);
    $('#copyBtn').addEventListener('click', ()=>{ const code=$('#detectedCode').value; if(code) navigator.clipboard.writeText(code); });
    $('#exportBtn').addEventListener('click', exportCSV);
    $('#exportBtnMobile').addEventListener('click', exportCSV);
    $('#clearBtn').addEventListener('click', ()=>{ if(confirm('¿Vaciar la lista de conformados?')){ state.conformados=[]; persistConformados(); paintConformados(); }});

    // Atajo global para confirmar rápido
    document.addEventListener('keydown', e=>{ if(e.key==='c' && (e.ctrlKey||e.metaKey)) $('#confirmBtn').click(); });

    // ===== Pruebas =====
    $('#btnTestCSV').addEventListener('click', ()=>{
      const sample = 'codigo,desc,qty\r\n123,Item A,5\r\n"124,7",Item B,10\r\n125,"Item, C",0\r\n';
      const parsedA = parseCSVAuto(sample);
      console.assert(parsedA.rows.length===4, 'CSV coma: 4 filas contando header');
      console.assert(parsedA.rows[2][0]==='124,7', 'CSV coma: campo con coma entre comillas');

      const sampleB = '\uFEFFcodigo;desc;qty\n001;Item A;5\n002;"Item; B";3\n';
      const parsedB = parseCSVAuto(sampleB);
      console.assert(parsedB.delimiter===';', 'CSV punto y coma detectado');
      console.assert(parsedB.rows[2][1]==='Item; B', 'CSV punto y coma respeta comillas internas');

      console.log('✅ Test CSV OK', {coma: parsedA, puntoYComa: parsedB});
    });

    $('#btnTestExport').addEventListener('click', ()=>{
      state.columns = ['codigo','desc'];
      state.exportDelimiter = ';';
      state.conformados = [
        {timestamp:'2025-10-22T12:00:00Z', codigo:'ABC', _match:'1', desc:'Algo'},
        {timestamp:'2025-10-22T12:01:00Z', codigo:'XYZ', _match:'0', desc:'Otra'}
      ];
      exportCSV();
      console.log('✅ Test export OK (deberías ver un archivo descargado)');
    });
  });

  if(typeof window !== 'undefined'){
    window.__SCAN__ = {
      state,
      parseCSV,
      parseCSVAuto,
      detectDelimiter,
      uniqueColumnNames,
      normalizeRowValue,
      hydrateInventory,
      rebuildIndex,
      setInventoryStatus,
      loadFile,
      loadDefaultInventory,
      paintInventory,
      paintConformados,
      paintDetails,
      clearDetails,
      addConformado,
      exportCSV,
      startCamera,
      stopCamera,
      toggleTorch,
      switchCamera,
      scanOnce,
      detectLoop,
      onDetect,
      confetti,
      setChip,
      setScanLabel,
      ensureZXing,
      ensureSheetJS,
      persistConformados,
      restoreConformados,
      stateSnapshot: () => JSON.parse(JSON.stringify(state)),
    };
  }
  </script>
</body>
</html>
